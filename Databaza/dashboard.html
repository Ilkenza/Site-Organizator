<!DOCTYPE html>
<html lang="sr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .flatpickr-calendar {
            z-index: 11000 !important;
        }
    </style>
    <title>Site Organizer - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #050a30;
            min-height: 100vh;
            padding: 20px;
            padding-top: 100px;
            color: #E0E8F7;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #050a30 0%, #0F1E3D 100%);
            border-bottom: 2px solid #2A3E5F;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            z-index: 1000;
            flex-wrap: wrap;
        }

        .navbar-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #6CBBFB;
            white-space: nowrap;
        }

        .navbar-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .user-email-navbar {
            color: #A0D8FF;
            font-weight: 600;
            font-size: 0.95em;
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .user-email-navbar {
                display: none;
            }
        }

        .navbar-controls button {
            padding: 8px 16px;
            font-size: 0.85em;
            background: #1A2E52;
            color: #A0B4D0;
            border: 1px solid #2A3E5F;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .navbar-controls button:hover {
            background: #243A5E;
            color: #6CBBFB;
            border-color: #3A4E6F;
        }

        .navbar-controls button.logout-btn {
            background: #3D1F1F;
            color: #E57373;
            border: 1px solid #5C2A2A;
        }

        .navbar-controls button.logout-btn:hover {
            background: #4D2929;
            color: #FF8A8A;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: start;
            color: #E0E8F7;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #6CBBFB;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.8;
            color: #A0B4D0;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: linear-gradient(135deg, #0F1E3D 0%, #1A2E52 100%);
            border-radius: 10px;
            border: 1px solid #2A3E5F;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(42, 62, 95, 0.5);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card:last-child {
            border-bottom: none;
        }

        .card:hover {
            background: rgba(108, 187, 251, 0.05);
            transform: none;
            box-shadow: none;
        }

        .card-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .card-emoji {
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .card-text {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .card h3 {
            font-size: 0.8em;
            color: #A0B4D0;
            font-weight: 500;
            margin: 0;
        }

        .card .number {
            font-size: 1.2em;
            font-weight: bold;
            color: #6CBBFB;
            margin: 0;
        }

        .card .label {
            font-size: 0.75em;
            color: #6A8CB3;
            margin: 0;
        }

        .controls {
            background: linear-gradient(135deg, #0F1E3D 0%, #1A2E52 100%);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid #2A3E5F;
            height: fit-content;
        }

        .controls h3 {
            color: #6CBBFB;
            margin-bottom: 20px;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            color: #050a30;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button-group button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #1A2E52;
            color: #6CBBFB;
            border: 2px solid #6CBBFB;
        }

        button.secondary:hover {
            background: #2A3E5F;
        }

        .status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 2000;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;

        }

        .data-section {
            background: #0f1e3d;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .data-section h3 {
            color: #6CBBFB;
            margin-bottom: 15px;
        }

        /* TAB System CSS - NOTEPAD STYLE */
        .tabs-section {
            padding: 0 !important;
            display: flex;
            flex-direction: column;
            margin-top: 120px;
            border-radius: 0 0 10px 10px;
            position: relative;
        }

        .tabs-header {
            display: flex;
            background: transparent;
            gap: 20px;
            width: 100%;
            position: absolute;
            top: -51px;
            left: 0;
            border-radius: 0;
            align-items: flex-end;

        }

        .tab-button {
            flex: 1;
            padding: 14px 20px;
            background: #0b1638;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #556b85;
            transition: all 0.25s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
            top: 5px;
        }


        .tab-button:first-child {
            border-left: 1px solid #2A3E5F;
        }

        .tab-button:last-child {
            border-right: 1px solid #2A3E5F;
        }

        .tab-button:hover:not(.active) {
            background: #1a2e52;
            color: #7a8faa;
        }

        /* Strong active tab rules so inner elements always inherit the active color */
        .tab-button.active {
            color: #6CBBFB !important;
            background: #0f1e3d !important;
        }

        /* Make inner elements inherit color with high priority to override other rules */
        .tab-button .tab-icon,
        .tab-button .tab-label,
        .tab-button .tab-count {
            color: inherit !important;
            transition: color 0.12s ease, background 0.12s ease;
        }

        .tab-button.active .tab-icon,
        .tab-button.active .tab-label,
        .tab-button.active .tab-count {
            color: #6CBBFB !important;
        }

        .tab-button.active .tab-count {
            background: rgba(108, 187, 251, 0.2) !important;
        }

        /* Tab count chip - inherits color from parent tab button */
        .tab-count {
            background: rgba(108, 187, 251, 0.15);
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 6px;
            color: #A0B4D0;
            transition: background 0.12s ease, color 0.12s ease;
        }

        .tab-button.active .tab-count {
            background: rgba(108, 187, 251, 0.2);
            color: #6CBBFB;
        }

        /* Header label styling to match tab */


        /* Tab icons */
        .tab-icon {
            margin-right: 8px;
            font-size: 1.05em;
            vertical-align: middle;
            transition: color 0.12s ease, transform 0.08s ease;
        }





        .tab-content {
            display: none;
            padding: 25px;
            border-top-color: transparent;
            border-radius: 0 0 10px 10px;
            border: 1px solid #2A3E5F;
            border-top-color: transparent;


        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: auto;
        }

        #sitesContainer table td:nth-child(2) {
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        table th {
            background: #1a2e52;
            padding: 10px;
            text-align: left;
            color: #6CBBFB;
            font-weight: 600;
            font-size: 0.9em;
            border-bottom: 1px solid #6CBBFB;
            border-left: 1px solid #2a3e5f;
            border-top: 1px solid #2a3e5f;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        table th:hover {
            background: #2a3e5f;
        }

        /* Sort Icons */
        .sort-icon {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.85em;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        table th:hover .sort-icon {
            opacity: 1;
        }

        .sort-icon.active {
            opacity: 1;
        }

        .sort-icon.asc::after {
            content: ' \2191';
        }

        .sort-icon.desc::after {
            content: ' \2193';
        }

        .sort-icon.inactive::after {
            content: ' \21c5';
            opacity: 0.4;
        }

        table td {
            padding: 10px;
            border: 1px solid #2a5a8a;
            font-size: 0.9em;
            color: #E0E8F7;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            cursor: pointer;
        }

        table tbody tr {
            transition: background-color 0.2s;
        }

        table tbody tr:hover {
            background: rgba(108, 187, 251, 0.1);
        }

        /* Multi-select row styles */
        table tbody tr.row-selected {
            background: rgba(108, 187, 251, 0.2) !important;
            border-left: 3px solid #6CBBFB;
        }

        table tbody tr.row-selected:hover {
            background: rgba(108, 187, 251, 0.25) !important;
        }

        /* Floating bulk action bar - keep layout stable, use visibility instead of display */
        .bulk-action-bar {
            display: flex;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            align-items: center;
            gap: 0;
            background: #1A2E52;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #6CBBFB40;
            transition: opacity 0.18s ease, visibility 0.18s ease;
        }

        .bulk-action-bar.show {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .bulk-action-bar .bulk-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid #6CBBFB30;
        }

        .bulk-action-bar .bulk-btn:last-child {
            border-right: none;
        }

        .bulk-action-bar .bulk-btn-select-all {
            background: transparent;
            color: #6CBBFB;
            font-size: 16px;
            font-weight: bold;
            min-width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .bulk-action-bar .bulk-btn-select-all:hover {
            background: rgba(108, 187, 251, 0.15);
        }

        .bulk-action-bar .bulk-btn-select-all.all-selected {
            background: rgba(108, 187, 251, 0.2);
        }

        .bulk-action-bar .bulk-btn-edit {
            background: transparent;
            color: #6CBBFB;
        }

        .bulk-action-bar .bulk-btn-edit:hover {
            background: rgba(108, 187, 251, 0.15);
        }

        .bulk-action-bar .bulk-btn-delete {
            background: transparent;
            color: #FF6B6B;
        }

        .bulk-action-bar .bulk-btn-delete:hover {
            background: rgba(255, 107, 107, 0.15);
        }

        .bulk-action-bar .bulk-btn-cancel {
            background: transparent;
            color: #6CBBFB;
        }

        .bulk-action-bar .bulk-btn-cancel:hover {
            background: rgba(160, 180, 208, 0.15);
        }

        table tbody tr td:first-child a {
            display: inline;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #6CBBFB;
            text-decoration: none;
            transition: color 0.2s;
        }

        table tbody tr td:first-child a:hover {
            color: #A0D8FF;
            text-decoration: underline;
        }

        #sitesContainer table td:nth-child(2) {
            max-width: 600px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #sitesContainer table td:nth-child(2) a {
            color: #6CBBFB;
            text-decoration: none;
            display: inline;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.2s;
        }

        #sitesContainer table td:nth-child(2) a:hover {
            color: #A0D8FF;
            text-decoration: underline;
        }

        /* Pricing badge styling */
        .pricing-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Tag badge styling */
        .tag-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            margin-right: 6px;
            margin-bottom: 8px;

        }

        .color-radio {
            display: none;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .color-swatch::after {
            content: 'âœ“';
            color: white;
            font-size: 20px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }


        .color-radio:checked+.color-swatch {
            transition: none;
        }

        .color-radio:checked+.color-swatch[style*="background: #667eea"] {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #6CBBFB"] {
            outline: 2px solid #6CBBFB;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #52A69B"] {
            outline: 2px solid #52A69B;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #D98B8B"] {
            outline: 2px solid #D98B8B;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #E0A96D"] {
            outline: 2px solid #E0A96D;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #D98BAC"] {
            outline: 2px solid #D98BAC;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch[style*="background: #D4B86A"] {
            outline: 2px solid #D4B86A;
            outline-offset: 2px;
        }

        .color-radio:checked+.color-swatch::after {
            opacity: 1;
        }

        .pricing-badge.fully-free {
            background: #1A5E3F;
            color: #7FD8BE;
        }

        .pricing-badge.paid {
            background: #8B2C2C;
            color: #FFB3B3;
        }

        .pricing-badge.freemium {
            background: #8B7C1D;
            color: #FFE66D;
        }

        .pricing-badge.free-trial {
            background: #26547C;
            color: #8ECAE6;
        }

        @media (max-width: 1024px) {
            table th:first-child {
                width: 40%;
            }

            table tbody tr td:first-child {
                width: 40%;
            }

            #categoriesContainer table th:first-child,
            #categoriesContainer table td:first-child {
                width: 20%;
            }

            #tagsContainer table th:first-child,
            #tagsContainer table td:first-child {
                width: 18%;
            }

            /* Sites container na tablet */
            #sitesContainer table td:nth-child(2) {
                max-width: 500px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #sitesContainer table td:nth-child(2) a {
                color: #6CBBFB;
                text-decoration: none;
                display: block;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        @media (max-width: 768px) {
            table th:first-child {
                width: 35%;
            }

            table tbody tr td:first-child {
                width: 35%;
            }

            #categoriesContainer table th:first-child,
            #categoriesContainer table td:first-child {
                width: 20%;
            }

            #tagsContainer table th:first-child,
            #tagsContainer table td:first-child {
                width: 18%;
            }

            /* Sites container na mobile */
            #sitesContainer table td:nth-child(2) {
                max-width: 400px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #sitesContainer table td:nth-child(2) a {
                color: #6CBBFB;
                text-decoration: none;
                display: block;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            table {
                font-size: 0.85em;
            }

            table th,
            table td {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            table th:first-child {
                width: 30%;
            }

            table tbody tr td:first-child {
                width: 30%;
            }

            #categoriesContainer table th:first-child,
            #categoriesContainer table td:first-child {
                width: 18%;
            }

            #tagsContainer table th:first-child,
            #tagsContainer table td:first-child {
                width: 16%;
            }

            /* Sites container na mali mobile */
            #sitesContainer table td:nth-child(2) {
                max-width: 300px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #sitesContainer table td:nth-child(2) a {
                color: #6CBBFB;
                text-decoration: none;
                display: block;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            table {
                font-size: 0.75em;
            }

            table th,
            table td {
                padding: 6px;
            }
        }

        table tr:hover {
            background: rgba(108, 187, 251, 0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(108, 187, 251, 0.3);
            border-radius: 50%;
            border-top-color: #6CBBFB;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7A8FAA;
        }

        .empty-state p {
            font-size: 1.1em;
            margin-top: 10px;
        }

        .server-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #0F1E3D 0%, #1A2E52 100%);
            padding: 15px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #E0E8F7;
            border: 1px solid #2A3E5F;
        }

        .server-status.online {
            background: #1a472a;
            color: #6ee7b7;
            border-color: #6ee7b7;
        }

        .server-status.offline {
            background: #472025;
            color: #f87171;
            border-color: #f87171;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-dot.online {
            background: #6ee7b7;
        }

        .status-dot.offline {
            background: #f87171;
        }

        .status-dot.pending {
            background: #6CBBFB;
        }

        /* Inline small server dot for compact display near Sync */
        .server-dot-inline {
            width: 8px;
            height: 8px;
            display: inline-block;
            border-radius: 50%;
            vertical-align: middle;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        /* Minimal dropdown menu */
        .menu-dropdown {
            position: absolute;
            top: 36px;
            right: 0;
            min-width: 160px;
            background: #0f1e3d;
            border: 1px solid #2A3E5F;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            padding: 6px;
            display: none;
            z-index: 1500;
        }

        .menu-dropdown.open {
            display: block;
        }

        .menu-dropdown .dropdown-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            background: transparent;
            color: #E0E8F7;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            font-size: 13px;
            /* slightly smaller for compact filter UI */
        }

        /* Date filter specific smaller inputs */
        .date-filter-wrapper .menu-dropdown input[type="date"] {
            font-size: 13px;
            padding: 6px;
        }

        .menu-dropdown .dropdown-item:hover {
            background: rgba(108, 187, 251, 0.06);
            color: #A0D8FF;
        }

        /* Compact grouped buttons (Sync + Export + Server) */
        .btn-group-mini {
            display: flex;
            align-items: center;
            gap: 0;
            border-radius: 8px;
            overflow: visible;
            border: 1px solid #2A3E5F;
            background: transparent;
        }

        .btn-group-mini .btn-group-item {
            background: transparent;
            border: none;
            padding: 6px 10px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #A0B4D0;
            cursor: pointer;
        }

        /* Make primary look the same as other group items so all three buttons share the same neutral styling */
        .btn-group-mini .btn-group-item.primary {
            background: transparent;
            color: #A0B4D0;
        }

        .btn-group-mini .btn-group-item:hover {
            background: #243A5E;
            color: #A0D8FF;
        }

        /* Date filter: default = selected-like, hover = highlight, active/open = stronger */
        .date-filter-wrapper .btn-group-item {
            /* Default: subtle selected look so it reads as a control */
            background: rgba(108, 187, 251, 0.08);
            border: 1px solid rgba(108, 187, 251, 0.12);
            color: #6CBBFB;
            padding: 6px 10px;
            margin: 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

        .date-filter-wrapper .btn-group-item:hover {
            /* Hover: more contrast */
            background: rgba(108, 187, 251, 0.14);
            color: #A0D8FF;
            border-color: rgba(108, 187, 251, 0.18);
            box-shadow: 0 2px 8px rgba(18, 36, 58, 0.28);
        }

        .date-filter-wrapper .btn-group-item.active {
            /* Active / menu open: strongest visual */
            background: rgba(108, 187, 251, 0.22);
            border: 1px solid rgba(108, 187, 251, 0.28);
            box-shadow: 0 6px 20px rgba(6, 25, 48, 0.45);
        }

        /* Date modal preset buttons */
        #dateFilterModal .date-preset-btn {
            background: #1A2E52;
            /* same as cancel buttons */
            color: #E0E8F7;
            border: 1px solid #2A3E5F;
            border-radius: 8px;
            text-align: left;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

        #dateFilterModal .date-preset-btn:hover {
            background: #243A5E;
            box-shadow: 0 2px 8px rgba(18, 36, 58, 0.28);
        }

        #dateFilterModal .date-preset-btn.selected {
            background: #1E4976;
            /* stronger selected color */
            border-color: #3A6A9A;
            box-shadow: 0 6px 20px rgba(6, 25, 48, 0.45);
            color: #E0F7FF;
        }

        /* Date inputs focus style */
        #dateFilterModal input[type="date"] {
            background: #0f1e3d;
            border: 1px solid #2A3E5F;
            color: #E0E8F7;
            padding: 6px;
            border-radius: 6px;
        }

        #dateFilterModal input[type="date"]:focus {
            outline: none;
            border-color: #6CBBFB;
            box-shadow: 0 4px 14px rgba(108, 187, 251, 0.12);
        }

        input.form-control.input {
            background: #1A2E52;
            outline: none;
            border-radius: 6px;
            padding: 6px 8px;
            width: 100%;
            color: #E0E8F7;
            border: 1px solid #2A3E5F;
        }


        /* flatpickr dark calendar overrides: full UI palette */
        .flatpickr-calendar {
            background: #071428;
            /* modal dark */
            color: #E0E8F7;
            border: 1px solid #12263B;
            box-shadow: 0 12px 40px rgba(6, 25, 48, 0.6);
            border-radius: 10px;
        }

        .flatpickr-months,
        .flatpickr-weekdays,
        .flatpickr-days {
            background: transparent;
            color: #E0E8F7;
        }

        .flatpickr-current-month,
        .flatpickr-months .flatpickr-month {
            color: #E0E8F7;
            font-weight: 700;
        }



        .flatpickr-day {
            color: #CFE3FF;
        }

        .flatpickr-day.today {
            color: #CFE3FF;
        }

        .flatpickr-day:hover {
            background: #12314E;
            color: #EAF6FF;
        }

        /* Selected / range visuals use the modal accent */
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange {
            background: #1E4976 !important;
            border-color: #3A6A9A !important;
            color: #E0F7FF !important;
            box-shadow: 0 6px 20px rgba(6, 25, 48, 0.45) !important;
        }

        .flatpickr-day.inRange {
            background: rgba(30, 73, 118, 0.14);
        }

        .flatpickr-time {
            background: transparent;
        }

        .flatpickr-weekday {
            color: #EAF6FF !important;
            font-weight: 600 !important;
        }

        /* input calendar icon and colors */
        #dateFilterModal .flatpickr-input {
            background: #0f1e3d;
            border: 1px solid #2A3E5F;
            color: #E0E8F7;
            padding: 6px 36px 6px 10px;
            /* right padding for icon */
            border-radius: 6px;
            background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='16' height='16'%3E%3Crect x='3' y='5' width='18' height='16' rx='2' ry='2' fill='none' stroke='%236CBBFB' stroke-width='1.6'/%3E%3Cpath d='M16 3v4M8 3v4' stroke='%236CBBFB' stroke-width='1.6' stroke-linecap='round'/%3E%3Cpath d='M3 10h18' stroke='%236CBBFB' stroke-width='1.6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            cursor: pointer;
        }

        #dateFilterModal .flatpickr-input:focus {
            outline: none;
            border-color: #6CBBFB;
            box-shadow: 0 4px 14px rgba(108, 187, 251, 0.12);
        }

        /* calendar header nav accents */
        .flatpickr-current-month,
        .flatpickr-prev-month,
        .flatpickr-next-month {
            color: #E0E8F7;
        }

        .flatpickr-prev-month svg,
        .flatpickr-next-month svg {
            stroke: #6CBBFB;
        }

        .flatpickr-monthDropdown-month {
            background: #1A2E52 !important;
            color: #E0E8F7;
        }

        .flatpickr-current-month .numInputWrapper span.arrowUp:after,
        .flatpickr-current-month .numInputWrapper span.arrowDown:after {

            border-top-color: #E0E8F7;
            border-bottom-color: #E0E8F7;
        }

        .flatpickr-day.prevMonthDay {
            color: #3a6a9a;
        }

        .flatpickr-day.prevMonthDay:hover {
            background: #2a5a8a;
            color: #EAF6FF;
        }

        /* two-column preset buttons grid */
        #dateFilterModal .date-presets-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        #dateFilterModal .date-presets-grid .date-preset-btn {
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            border-radius: 8px;
            text-align: center;
            background: #1A2E52;
            /* modal button bg */
            color: #E0E8F7;
            border: 1px solid #2A3E5F;
            transition: background 0.12s ease, box-shadow 0.12s ease, transform 0.04s ease;
        }

        #dateFilterModal .date-presets-grid .date-preset-btn:hover {
            background: #243A5E;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(6, 25, 48, 0.22);
        }

        #dateFilterModal .date-presets-grid .date-preset-btn.selected {
            background: #1E4976;
            border-color: #3A6A9A;
            color: #E0F7FF;
            box-shadow: 0 6px 20px rgba(6, 25, 48, 0.45);
        }

        /* small adjustments for mobile alt input styling */
        .flatpickr-input[readonly] {
            cursor: pointer;
        }

        /* Compact logout button tweaks */
        #logoutCompactBtn i {
            transition: color 0.15s ease, transform 0.12s ease;
        }

        #logoutCompactBtn:hover i {
            color: #FF8A8A;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal.show {
            display: flex;
            align-items: center;

            overflow: hidden;
            justify-content: center;
        }

        .modal-content {
            background: #0f1e3d;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            text-align: center;
            border: 1px solid #2A3E5F;
            color: #E0E8F7;
        }

        #editModal .modal-content {
            max-width: 700px;
            width: 90%;
            text-align: left;
        }

        .modal-content h2 {
            color: #6CBBFB;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .modal-content p {
            color: #A0B4D0;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .modal-url {
            padding: 10px 0;
        }

        .delete-info-box {
            padding: 0;
        }

        .delete-info-row {
            margin-bottom: 16px;
        }

        .del .modal-content {
            max-width: 450px;
        }

        .delete-info-label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #A0B4D0;
            margin-bottom: 8px;
        }

        .delete-info-value {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #2A3E5F;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: #1A2E52;
            color: #6CBBFB;
            word-break: break-word;
            opacity: 0.9;
            box-sizing: border-box;
            max-height: 153px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 7;
            line-clamp: 7;
            -webkit-box-orient: vertical;
        }

        .delete-info-value strong {
            color: #E0E8F7;
            font-weight: 600;
        }

        .delete-url-link {
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-url-link:hover {
            color: #A0D8FF;
            text-decoration: underline;
        }

        .delete-info-row.two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .delete-info-row.two-column>div:first-child,
        .delete-info-row.two-column>div:last-child {
            margin-bottom: 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-delete-confirm {
            background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }



        .btn-cancel-modal {
            background: #2A3E5F;
            color: #6CBBFB;
            padding: 10px 20px;
            border: 2px solid #6CBBFB;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-cancel-modal:hover {
            background: #1A2E52;

        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 5px;
            transition: transform 0.2s;
        }

        .btn-delete:hover {
            background: #bb2d3b;
        }

        .action-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
            color: #E0E8F7;
        }

        .icon-btn:hover {
            background: rgba(108, 187, 251, 0.2);
        }

        .icon-edit:hover {
            color: #6CBBFB;
        }

        .icon-delete:hover {
            color: #ff6b6b;
        }

        .edit-modal-content {
            background: #0F1E3D;
            color: #E0E8F7;
            max-width: 700px;
            width: 90%;
        }

        .edit-modal-content h2 {
            color: #6CBBFB;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .edit-form-group {
            margin-bottom: 16px;
        }

        .edit-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #E0E8F7;
        }

        .edit-form-group input,
        .edit-form-group select {
            padding: 10px 12px;
            border: 2px solid #1A2E52;
            border-radius: 8px;
            font-size: 14px;
            background: #1A2E52;
            color: #E0E8F7;
            font-family: inherit;
            transition: all 0.2s;
        }

        .edit-form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236CBBFB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .edit-form-group input:focus,
        .edit-form-group select:focus {
            outline: none;
            border-color: transparent;
        }

        .edit-form-group input::placeholder {
            color: #8A9FB5;
        }

        input#editUrl {
            width: 100%;
        }

        .edit-label {
            margin-bottom: 10px;
        }

        #editTagsCheckboxList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border: 1px solid #2A3E5F !important;
            border-radius: 4px !important;
            padding: 8px !important;
            max-height: 150px !important;
            overflow-y: auto !important;
        }

        #editTagsCheckboxList label {
            display: flex;
            align-items: center;
            margin: 0 !important;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        #editTagsCheckboxList input[type="checkbox"] {
            width: 16px !important;
            height: 16px !important;
            margin: 0 !important;
            cursor: pointer;
        }

        #editCategoriesCheckboxList {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border: 1px solid #2A3E5F !important;
            border-radius: 4px !important;
            padding: 8px !important;
            max-height: 150px !important;
            overflow-y: auto !important;
        }

        #editCategoriesCheckboxList>div {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid;
            box-sizing: border-box;
            width: auto;
        }

        #editCategoriesCheckboxList>div:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #editCategoriesCheckboxList input[type="checkbox"] {
            display: none;
        }

        #editCategoriesCheckboxList label {
            margin: 0;
            cursor: pointer;
            font-size: 12px;
        }

        #editTagsCheckboxList>div {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid;
            box-sizing: border-box;
            width: auto;
        }

        #editTagsCheckboxList>div:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #editTagsCheckboxList input[type="checkbox"] {
            display: none;
        }

        #editTagsCheckboxList label {
            margin: 0;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-save-edit {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #6CBBFB 0%, #4A9FD8 100%);
            color: #050a30;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel-edit {
            flex: 1;
            padding: 12px;
            background: #1A2E52;
            color: #E0E8F7;
            border: 2px solid #2A3E5F;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel-edit:hover {
            background: #2A3E5F;
        }

        /* Add Site Button */
        .btn-add {
            padding: 8px 16px;
            background: #1E4976;
            color: #6CBBFB;
            border: 1px solid #2A5A8A;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            /* keep label on one line */
            flex-shrink: 0;
            /* don't let it shrink when space is tight */
        }

        .btn-add:hover {
            background: #2A5A8A;
            color: #8DD0FF;
        }

        .btn-add .add-icon {
            color: #6CBBFB;
            margin-right: 8px;
            font-size: 0.95em;
            vertical-align: middle;
            transition: color 0.15s ease, transform 0.12s ease;
        }

        .btn-add:hover .add-icon {
            color: #8DD0FF;
        }

        /* ========== ADD SITE MODAL STYLES (Extension UI) ========== */
        .add-site-modal-content {
            background: #0F1E3D;
            padding: 28px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            border: 2px solid #1A2E52;
            text-align: left;
            position: relative;
        }

        .add-site-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #1A2E52;
        }

        .add-site-header h2 {
            color: #6CBBFB;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .modal-close-btn {
            position: absolute;
            top: 22px;
            right: 16px;
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            padding: 4px 8px;
            color: #6CBBFB;
            transition: all 0.2s;
            line-height: 1;
        }

        /* Red close button for delete modals */
        .del .modal-close-btn,
        #deleteCategoryModal .modal-close-btn,
        #deleteTagModal .modal-close-btn {
            color: #FF6B6B;
        }

        .add-site-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
            display: none;
        }

        .add-site-message.success {
            background: #1B4332;
            color: #95D5B2;
            border: 2px solid #40916C;
            display: block;
        }

        .add-site-message.error {
            background: #6A1B1B;
            color: #FC8181;
            border: 2px solid #E53E3E;
            display: block;
        }


        .add-site-form-group {
            margin-bottom: 16px;
        }

        .add-site-form-group label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #E0E8F7;
        }

        .add-site-form-group input[type="url"],
        .add-site-form-group input[type="text"],
        .add-site-form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #1A2E52;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
            background: #1A2E52;
            color: #E0E8F7;
        }

        .add-site-form-group input[type="url"]:focus,
        .add-site-form-group input[type="text"]:focus,
        .add-site-form-group select:focus {
            outline: none;
            background-color: rgba(108, 187, 251, 0.1);
        }

        .add-site-form-group input[type="url"]::placeholder,
        .add-site-form-group input[type="text"]::placeholder {
            color: #8A9FB5;
        }

        .add-site-form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236CBBFB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .add-site-form-group select option {
            background: #1A2E52;
            color: #E0E8F7;
            padding: 8px;
        }

        .add-site-checkbox-list {
            max-height: 180px;
            overflow-y: auto;
            border: 2px solid #1A2E52;
            border-radius: 8px;
            padding: 10px;
            background: #1A2E52;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .add-site-checkbox-item {
            display: inline-flex;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            margin-right: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            position: relative;
            border: 1px solid;
            box-sizing: border-box;
            width: auto;
        }

        .add-site-checkbox-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .add-site-checkbox-item:has(input[type="checkbox"]:checked) {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            font-weight: 700;
            outline-width: 1px;
            outline-style: solid;
            outline-offset: 2px;
        }

        .add-site-checkbox-item.outline-animate {
            outline: 1px solid currentColor;
            outline-offset: 2px;
        }

        @keyframes outlineAnimation {
            0% {
                outline: 1px solid currentColor;
                outline-offset: 0px;
            }

            50% {
                outline: 1px solid currentColor;
                outline-offset: 2px;
            }

            100% {
                outline: 1px solid currentColor;
                outline-offset: 2px;
            }
        }

        .add-site-checkbox-item:has(input[type="checkbox"]:checked)::before {
            display: none;
        }

        .add-site-checkbox-item input[type="checkbox"] {
            display: none;
        }

        .add-site-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
            color: #E0E8F7;
        }

        .add-site-hint {
            font-size: 12px;
            color: #8A9FB5;
            margin-top: 6px;
        }

        .add-site-button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .add-site-btn-save {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #1E4976;
            color: #E0E8F7;
        }

        .add-site-btn-save:hover {
            background: #2A5B9E;
            box-shadow: 0 2px 8px rgba(30, 73, 118, 0.4);
        }

        .del .add-site-header,
        #deleteCategoryModal .add-site-header,
        #deleteTagModal .add-site-header {
            border-bottom-color: #5C2A2A;
        }

        .del .modal-content {
            max-width: 450px;
            border: 2px solid #5C2A2A;
            background: linear-gradient(135deg, #0F1E3D 0%, #1a0a0a 100%);
        }

        #deleteCategoryModal .modal-content,
        #deleteTagModal .modal-content {
            max-width: 450px;
            border: 2px solid #5C2A2A;
            background: linear-gradient(135deg, #0F1E3D 0%, #1a0a0a 100%);
        }

        .del .add-site-btn-save,
        #deleteCategoryModal .add-site-btn-save,
        #deleteTagModal .add-site-btn-save {
            background: #8B3A3A;
            color: white;
            border: none;
        }

        .del .add-site-btn-save:hover,
        #deleteCategoryModal .add-site-btn-save:hover,
        #deleteTagModal .add-site-btn-save:hover {
            background: #A85252;
            box-shadow: 0 2px 8px rgba(139, 58, 58, 0.4);
        }

        .del .add-site-header h2,
        #deleteCategoryModal .add-site-header h2,
        #deleteTagModal .add-site-header h2 {
            color: #FF6B6B;
        }

        .del .modal-content {
            max-width: 450px;
        }


        .add-site-btn-cancel {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #1A2E52;
            color: #E0E8F7;
        }

        .add-site-btn-cancel:hover {
            background: #2A3E5F;
            box-shadow: 0 2px 8px rgba(26, 46, 82, 0.4);
        }

        /* ========== AUTH STYLES ========== */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: #0F1E3D;
            padding: 40px;
            border-radius: 16px;
            border: 2px solid #2A3E5F;
            text-align: center;
        }

        .auth-container h2 {
            color: #6CBBFB;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .auth-container .auth-info {
            color: #A0B4D0;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .auth-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #E0E8F7;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #1A2E52;
            border-radius: 8px;
            font-size: 15px;
            background: #1A2E52;
            color: #E0E8F7;
            transition: all 0.2s;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #6CBBFB;
        }

        .auth-form-group input::placeholder {
            color: #8A9FB5;
        }

        .auth-btn {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #2A5A8A;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #1E4976;
            color: #6CBBFB;
            margin-top: 10px;
        }

        .auth-btn:hover {
            background: #2A5A8A;
            color: #8DD0FF;
            border-color: #3A6A9A;
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            margin-top: 20px;
            font-size: 13px;
            color: #A0B4D0;
        }

        .auth-toggle a {
            color: #6CBBFB;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .auth-message.success {
            display: block;
            background: #1B4332;
            color: #95D5B2;
            border: 2px solid #40916C;
        }

        .auth-message.error {
            display: block;
            background: #6A1B1B;
            color: #FC8181;
            border: 2px solid #E53E3E;
        }

        .hidden {
            display: none !important;
        }



        .user-email-display {
            color: #E0E8F7;
            font-size: 14px;
            font-weight: 500;
        }





        .search-bar-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            width: 100%;
            max-width: 640px;
            /* widen so controls aren't cramped */
        }

        .search-input {
            padding: 8px 12px 8px 36px;
            border: 1px solid #2A5A8A;
            border-radius: 6px;
            background: #1A2E52 url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238A9FB5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cpath d='m21 21-4.35-4.35'%3e%3c/path%3e%3c/svg%3e") no-repeat;
            background-position: 10px center;
            background-size: 18px 18px;
            color: #E0E8F7;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
            flex: 1;
            min-width: 150px;
        }

        .search-input:focus {
            outline: none;
            border-color: #6CBBFB;
            background-color: rgba(26, 46, 82, 0.8);
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236CBBFB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cpath d='m21 21-4.35-4.35'%3e%3c/path%3e%3c/svg%3e");
            background-position: 10px center;
            background-size: 18px 18px;
            background-repeat: no-repeat;
        }

        .search-input::placeholder {
            color: #8A9FB5;
        }

        @media (max-width: 768px) {
            .search-bar-wrapper {
                flex-direction: column;
                max-width: 100%;
            }

            .search-input {
                width: 100%;
            }
        }

        .category-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(108, 187, 251, 0.2);
            color: #6CBBFB;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 3px;
        }

        /* Custom table scrollbars to match UI */
        #sitesContainer,
        #categoriesContainer,
        #tagsContainer {
            scrollbar-width: thin;
            /* Firefox */
            scrollbar-color: #6CBBFB44 #0f1e3d;
            /* thumb track for Firefox */
        }

        /* WebKit-based browsers */
        #sitesContainer::-webkit-scrollbar,
        #categoriesContainer::-webkit-scrollbar,
        #tagsContainer::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        #sitesContainer::-webkit-scrollbar-track,
        #categoriesContainer::-webkit-scrollbar-track,
        #tagsContainer::-webkit-scrollbar-track {
            background: #0f1e3d;
            /* track matches card background */
            border-radius: 10px;
        }

        #sitesContainer::-webkit-scrollbar-thumb,
        #categoriesContainer::-webkit-scrollbar-thumb,
        #tagsContainer::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(108, 187, 251, 0.28), rgba(26, 46, 82, 0.9));
            border-radius: 8px;
            border: 2px solid #0f1e3d;
            /* creates an inset effect */
        }

        #sitesContainer::-webkit-scrollbar-thumb:hover,
        #categoriesContainer::-webkit-scrollbar-thumb:hover,
        #tagsContainer::-webkit-scrollbar-thumb:hover {
            background: #6CBBFB;
            /* stronger on hover */
        }

        /* Small corner fix for overflow on the containers */
        #sitesContainer,
        #categoriesContainer,
        #tagsContainer {
            overflow: auto;
        }
    </style>
</head>

<body>
    <!-- Auth Section (hidden by default to avoid flash on load) -->
    <div id="authSection" class="auth-container hidden">
        <h2>ðŸ“Š Site Organizer</h2>
        <p class="auth-info">Sign in to access your dashboard</p>

        <div id="authMessage" class="auth-message"></div>

        <!-- Login Form -->
        <div id="loginForm">
            <div class="auth-form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
            </div>
            <div class="auth-form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
            <button class="auth-btn" id="loginBtn">Sign In</button>
        </div>


    </div>

    <!-- Dashboard Section (hidden until logged in) -->
    <div id="dashboardSection" class="hidden">
        <!-- Fixed Navbar -->
        <div class="navbar">
            <div class="navbar-title">ðŸ“Š Site Organizer</div>

            <div class="navbar-controls">
                <span id="userEmailDisplay" class="user-email-navbar"
                    style="margin-right:10px; font-weight:600; color:#A0B4D0; font-size:0.95em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;">&nbsp;</span>
                <!-- Compact grouped controls: Sync | Export toggle | Server dot -->
                <div class="btn-group-mini" style="position:relative; display:flex; align-items:center;">
                    <div id="syncExportMenu" class="menu-dropdown">
                        <button class="dropdown-item" onclick="exportData(); closeSyncExportMenu();">Export
                            (JSON)</button>
                        <button class="dropdown-item" onclick="exportDataCSV(); closeSyncExportMenu();">Export
                            (CSV)</button>
                    </div>
                    <button id="syncExportToggle" class="btn-icon btn-group-item" onclick="toggleSyncExportMenu()"
                        aria-haspopup="true" aria-expanded="false" title="Export" aria-label="Export"><i
                            class="fa-solid fa-upload" style="font-size:13px"></i></button>
                    <button id="syncButton" onclick="syncData()" class="btn-icon btn-group-item primary"
                        title="Sync (last: never)"><i id="syncIcon" class="fa-solid fa-sync"></i><i
                            class="fa-solid fa-circle-notch fa-spin" id="syncSpinner"
                            style="display:none;margin-left:6px;font-size:14px"></i><span id="syncStatusDot"
                            class="status-dot server-dot-inline offline" style="margin-left:8px;"></span></button>
                    <button id="serverDotBtn" class="btn-icon btn-group-item" onclick="checkServerStatus()"
                        title="Server: Checking" aria-label="Server status"><i class="fa-solid fa-server"
                            style="font-size:12px"></i><span id="serverDot" class="status-dot server-dot-inline offline"
                            style="margin-left:8px;width:8px;height:8px;display:inline-block;border-radius:50%;vertical-align:middle"></span></button>
                    <button id="logoutCompactBtn" class="btn-icon btn-group-item" title="Sign out" aria-label="Sign out"
                        onclick="logoutUser()"><i class="fa-solid fa-right-from-bracket"
                            style="font-size:13px;color:#E57373"></i></button>
                </div>
            </div>
            <div class="status" id="status"></div>
        </div>

        <div class="container">
            <header>

                <h1 style="text-align: center;"><i class="fa-solid fa-globe"
                        style="margin-right:8px;color:#1E4976;font-size:1.2em" aria-hidden="true"></i> Site Organizer
                    Dashboard</h1>
                <p style="text-align: center;">Manage your organized websites</p>
            </header>

            </header>

            <!-- Sites, Categories and Tags - TAB system -->
            <div class="data-section tabs-section">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="sites" onclick="switchTab('sites', this)"><i
                            class="fa-solid fa-location-dot tab-icon" aria-hidden="true"></i> <span
                            class="tab-label">Sites</span> <span id="sitesTableCount"
                            class="tab-count">0</span></button>
                    <button class="tab-button" data-tab="categories" onclick="switchTab('categories', this)"><i
                            class="fa-solid fa-folder tab-icon" aria-hidden="true"></i> <span
                            class="tab-label">Categories</span> <span id="categoriesTableCount"
                            style="background: rgba(108, 187, 251, 0.15);  padding: 2px 10px; border-radius: 10px; font-size: 0.8em; font-weight: 600; margin-left: 6px;">0</span></button>
                    <button class="tab-button" data-tab="tags" onclick="switchTab('tags', this)"><i
                            class="fa-solid fa-tags tab-icon" aria-hidden="true"></i> <span
                            class="tab-label">Tags</span> <span id="tagsTableCount" class="tab-count">0</span></button>
                </div>

                <!-- Sites Tab -->
                <div id="sitesTab" class="tab-content active">
                    <div id="categoryHeader" class="category-header"
                        style="display:none; align-items:center; justify-content: center; gap:12px; margin-bottom:25px;">
                        <div style="font-size:18px; display:flex; align-items:flex-start; gap:8px;"><i
                                class="fa-solid fa-folder tab-icon" aria-hidden="true"
                                style="font-size:18px; position:relative; top: 3px;"></i> <strong
                                id="categoryHeaderText"><span class="tab-label">Sites in category:</span> <span
                                    id="currentCategoryName" class="category-name-label"></span> <span
                                    id="currentCategoryCount" class="category-count-badge">0</span></strong></div>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 10px;">
                        <div id="bulkActionBar" class="bulk-action-bar">
                            <button class="bulk-btn bulk-btn-select-all" onclick="selectAllSites()" title="Select All">
                                <i id="selectAllIcon" class="fa-regular fa-square-minus"></i>
                                <span id="selectedCount" style="margin-left: 6px;">0</span>
                            </button>
                            <button class="bulk-btn bulk-btn-edit" onclick="bulkEditSites()" title="Edit"><i
                                    class="fa-solid fa-pen"></i></button>
                            <button class="bulk-btn bulk-btn-delete" onclick="bulkDeleteSites()" title="Delete"><i
                                    class="fa-solid fa-trash"></i></button>
                            <button class="bulk-btn bulk-btn-cancel" onclick="clearSelection()" title="Cancel"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="search-bar-wrapper">
                            <div class="date-filter-wrapper" style="position:relative;margin-right:8px;">
                                <button id="dateFilterToggle" class="btn-icon btn-group-item"
                                    onclick="toggleDateFilterMenu()" aria-haspopup="dialog" aria-expanded="false"
                                    title="Filter by created date">
                                    <i class="fa-solid fa-calendar-days" style="font-size:13px"></i>
                                    <span id="dateFilterLabel"
                                        style="margin-left:6px;font-size:0.9em;color:#A0B4D0">All</span>
                                </button>
                            </div>

                            <input type="text" id="sitesSearch" class="search-input" placeholder="Search sites...">

                            <button class="btn-add" onclick="showAddSiteModal()"><i class="fa-solid fa-plus add-icon"
                                    aria-hidden="true"></i> Add Site</button>
                        </div>
                    </div>
                    <div id="sitesContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="empty-state">
                            <p>No data. Click "Load Data" to load sites.</p>
                        </div>
                    </div>
                </div>

                <!-- Categories Tab -->
                <div id="categoriesTab" class="tab-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 10px;">
                        <div id="categoryBulkActionBar" class="bulk-action-bar">
                            <button class="bulk-btn bulk-btn-select-all" onclick="selectAllCategories()"
                                title="Select All">
                                <i id="categorySelectAllIcon" class="fa-regular fa-square-minus"></i>
                                <span id="selectedCategoryCount" style="margin-left: 6px;">0</span>
                            </button>
                            <button class="bulk-btn bulk-btn-edit" onclick="bulkEditCategories()" title="Edit"><i
                                    class="fa-solid fa-pen"></i></button>
                            <button class="bulk-btn bulk-btn-delete" onclick="bulkDeleteCategories()" title="Delete"><i
                                    class="fa-solid fa-trash"></i></button>
                            <button class="bulk-btn bulk-btn-cancel" onclick="clearCategorySelection()"
                                title="Cancel"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="search-bar-wrapper">
                            <input type="text" id="categoriesSearch" class="search-input"
                                placeholder="Search categories...">
                            <button class="btn-add" onclick="showAddCategoryModal()"><i
                                    class="fa-solid fa-plus add-icon" aria-hidden="true"></i> Add Category</button>
                        </div>
                    </div>
                    <div id="categoriesContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="empty-state">
                            <p>No data.</p>
                        </div>
                    </div>
                </div>

                <!-- Tags Tab -->
                <div id="tagsTab" class="tab-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 10px;">
                        <div id="tagBulkActionBar" class="bulk-action-bar">
                            <button class="bulk-btn bulk-btn-select-all" onclick="selectAllTags()" title="Select All">
                                <i id="tagSelectAllIcon" class="fa-regular fa-square-minus"></i>
                                <span id="selectedTagCount" style="margin-left: 6px;">0</span>
                            </button>
                            <button class="bulk-btn bulk-btn-edit" onclick="bulkEditTags()" title="Edit"><i
                                    class="fa-solid fa-pen"></i></button>
                            <button class="bulk-btn bulk-btn-delete" onclick="bulkDeleteTags()" title="Delete"><i
                                    class="fa-solid fa-trash"></i></button>
                            <button class="bulk-btn bulk-btn-cancel" onclick="clearTagSelection()" title="Cancel"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="search-bar-wrapper">
                            <input type="text" id="tagsSearch" class="search-input" placeholder="Search tags...">
                            <button class="btn-add" onclick="showAddTagModal()"><i class="fa-solid fa-plus add-icon"
                                    aria-hidden="true"></i> Add Tag</button>
                        </div>
                    </div>
                    <div id="tagsContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="empty-state">
                            <p>No data.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Server status (kept hidden; compact inline indicator used instead) -->
            <div class="server-status offline hidden" id="serverStatus" style="display:none">
                <div class="status-dot"></div>
                <span>Checking server...</span>
            </div>

            <!-- Delete modal -->
            <div id="deleteModal" class="modal del">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âš ï¸ Confirm Deletion</h2>
                        <button class="modal-close-btn" onclick="closeDeleteModal()">x</button>
                    </div>
                    <div class="modal-url" id="deleteUrl"></div>
                    <div class="add-site-button-group">
                        <button class="add-site-btn-cancel" id="cancelDelete">Cancel</button>
                        <button class="add-site-btn-save" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Bulk Delete modal -->
            <div id="bulkDeleteModal" class="modal del">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âš ï¸ Confirm Deletion</h2>
                        <button class="modal-close-btn" onclick="closeBulkDeleteModal()">x</button>
                    </div>
                    <div class="modal-url" id="bulkDeleteUrl" style="max-height: 400px; overflow-y: auto;"></div>
                    <p style="color: #FF6B6B; font-size: 0.9em; margin-top: 16px; font-weight: 500;">âš ï¸ This action
                        cannot be undone</p>
                    <div class="add-site-button-group">
                        <button class="add-site-btn-cancel" id="cancelBulkDelete"
                            onclick="cancelBulkDelete()">Cancel</button>
                        <button class="add-site-btn-save" id="confirmBulkDelete"
                            onclick="confirmBulkDelete()">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Bulk Delete modal -->
            <div id="deleteModal" class="modal del">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âš ï¸ Confirm Deletion</h2>
                        <button class="modal-close-btn" onclick="closeDeleteModal()">x</button>
                    </div>
                    <div class="modal-url" id="deleteUrl" style="max-height: 400px; overflow-y: auto;"></div>
                    <p style="color: #FF6B6B; font-size: 0.9em; margin-top: 16px; font-weight: 500;">âš ï¸ This action
                        cannot be undone</p>
                    <div class="add-site-button-group">
                        <button class="add-site-btn-cancel" id="cancelModal">Cancel</button>
                        <button class="add-site-btn-save" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Edit site modal -->
            <div id="editModal" class="modal">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âœï¸ Edit Site</h2>
                        <button class="modal-close-btn" onclick="closeEditModal()">x</button>
                    </div>

                    <div id="editSiteMessage" class="add-site-message"></div>

                    <form id="editForm">
                        <div class="add-site-form-group">
                            <label for="editName" class="edit-label">Site Name</label>
                            <input type="text" id="editName" placeholder="e.g. Google Docs" required>
                        </div>

                        <div class="add-site-form-group">
                            <label for="editUrl" class="edit-label">URL Address</label>
                            <input type="url" id="editUrl" placeholder="https://example.com" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Category</label>
                            <div id="editCategoriesCheckboxList" class="add-site-checkbox-list">
                            </div>
                            <div class="add-site-hint">Select one or more categories</div>
                        </div>

                        <div class="add-site-form-group">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label class="edit-label">Tags</label>
                            </div>
                            <div id="editTagsCheckboxList" class="add-site-checkbox-list">
                            </div>
                            <div class="add-site-hint">Select one or more tags</div>
                        </div>

                        <div class="add-site-form-group">
                            <label for="editPricing" class="edit-label">Billing Model</label>
                            <select id="editPricing" required>
                            </select>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel" id="cancelEdit">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Site modal -->
            <div id="addSiteModal" class="modal">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>ðŸ“Œ Add New Site</h2>
                        <button class="modal-close-btn" onclick="closeAddSiteModal()">x</button>
                    </div>

                    <div id="addSiteMessage" class="add-site-message"></div>

                    <form id="addSiteForm">
                        <div class="add-site-form-group">
                            <label for="addName" class="edit-label">Site Name</label>
                            <input type="text" id="addName" placeholder="npr. Google Docs" required>
                        </div>

                        <div class="add-site-form-group">
                            <label for="addUrl" class="edit-label">URL address</label>
                            <input type="url" id="addUrl" placeholder="https://example.com" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Category</label>
                            <div id="addCategoriesCheckboxList" class="add-site-checkbox-list">
                            </div>
                            <div class="add-site-hint">Select one or more categories</div>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Tags</label>
                            <div id="addTagsCheckboxList" class="add-site-checkbox-list">
                            </div>
                            <div class="add-site-hint">Select one or more tags</div>
                        </div>

                        <div class="add-site-form-group">
                            <label for="addPricing" class="edit-label">Billing Model</label>
                            <select id="addPricing" required>
                                <option value="">Select...</option>
                                <option value="fully_free">Fully Free</option>
                                <option value="freemium">Freemium</option>
                                <option value="free_trial">Free Trial</option>
                                <option value="paid">Paid</option>
                            </select>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel"
                                onclick="closeAddSiteModal()">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delete category modal -->
            <div id="deleteCategoryModal" class="modal">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âš ï¸ Confirm Deletion</h2>
                        <button class="modal-close-btn" onclick="closeDeleteCategoryModal()">x</button>
                    </div>
                    <div class="delete-info-box">
                        <div class="delete-info-row">
                            <label class="delete-info-label">Category Name</label>
                            <div class="delete-info-value" id="deleteCategoryName"></div>
                        </div>
                    </div>
                    <p style="color: #FF6B6B; font-size: 0.9em; margin-top: 16px; font-weight: 500;">âš ï¸ This action
                        cannot be undone</p>
                    <div class="add-site-button-group">
                        <button class="add-site-btn-cancel" id="cancelDeleteCategory">Cancel</button>
                        <button class="add-site-btn-save" id="confirmDeleteCategory">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Edit tag modal -->
            <div id="editTagModal" class="modal">
                <div class="modal-content add-site-modal-content" style="max-width: 450px;">
                    <div class="add-site-header">
                        <h2>âœï¸ Edit Tag</h2>
                        <button class="modal-close-btn" onclick="closeEditTagModal()">x</button>
                    </div>

                    <div id="editTagMessage" class="add-site-message"></div>

                    <form id="editTagForm">
                        <div class="add-site-form-group">
                            <label for="editTagName" class="edit-label">Tag Name</label>
                            <input type="text" id="editTagName" placeholder="e.g. JavaScript" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Color</label>
                            <div class="color-palette">
                                <input type="radio" name="editTagColor" id="editTagColor1" value="#667eea"
                                    class="color-radio">
                                <label for="editTagColor1" class="color-swatch" style="background: #667eea;"
                                    title="Purple"></label>

                                <input type="radio" name="editTagColor" id="editTagColor2" value="#6CBBFB"
                                    class="color-radio">
                                <label for="editTagColor2" class="color-swatch" style="background: #6CBBFB;"
                                    title="Blue"></label>

                                <input type="radio" name="editTagColor" id="editTagColor3" value="#52A69B"
                                    class="color-radio">
                                <label for="editTagColor3" class="color-swatch" style="background: #52A69B;"
                                    title="Teal"></label>
                                <input type="radio" name="editTagColor" id="editTagColor4" value="#D98B8B"
                                    class="color-radio">
                                <label for="editTagColor4" class="color-swatch" style="background: #D98B8B;"
                                    title="Coral"></label>
                                <input type="radio" name="editTagColor" id="editTagColor5" value="#E0A96D"
                                    class="color-radio">
                                <label for="editTagColor5" class="color-swatch" style="background: #E0A96D;"
                                    title="Orange"></label>
                                <input type="radio" name="editTagColor" id="editTagColor6" value="#D98BAC"
                                    class="color-radio">
                                <label for="editTagColor6" class="color-swatch" style="background: #D98BAC;"
                                    title="Pink"></label>
                                <input type="radio" name="editTagColor" id="editTagColor7" value="#D4B86A"
                                    class="color-radio">
                                <label for="editTagColor7" class="color-swatch" style="background: #D4B86A;"
                                    title="Yellow"></label>
                            </div>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel" id="cancelEditTag">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Filter modal -->
            <div id="dateFilterModal" class="modal">
                <div class="modal-content add-site-modal-content" style="max-width:420px;">
                    <div class="add-site-header">
                        <h2>ðŸ“… Filter by Created Date</h2>
                        <button class="modal-close-btn" onclick="closeDateFilterModal()">x</button>
                    </div>
                    <div style="padding: 10px 0;">
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <div class="modal-buttons date-presets-grid"
                                style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="all"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('all')">All</button>
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="today"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('today')">Today</button>
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="yesterday"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('yesterday')">Yesterday</button>
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="week"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('week')">Last 7 days</button>
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="month"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('month')">Last 30 days</button>
                                <button class="add-site-btn-cancel date-preset-btn" data-filter-type="last90"
                                    style="width:100%;text-align:center;padding:10px 12px;"
                                    onclick="setDateFilter('last90')">Last 90 days</button>
                            </div>
                            <div style="border-top:1px solid #2A3E5F;margin-top:6px;padding-top:6px;">
                                <div style="padding:6px 0px;font-weight:600;color:#A0B4D0">Custom range</div>
                                <div style="display:flex;gap:10px;padding:6px 0px;">
                                    <input type="date" id="dateFilterFrom"
                                        style="flex:1;background:#0f1e3d;border:1px solid #2A3E5F;color:#E0E8F7;padding:6px;border-radius:6px"
                                        placeholder="Date From">
                                    <input type="date" id="dateFilterTo"
                                        style="flex:1;background:#0f1e3d;border:1px solid #2A3E5F;color:#E0E8F7;padding:6px;border-radius:6px"
                                        placeholder="Date To">
                                </div>
                                <div class="add-site-button-group" style="padding:6px 10px;justify-content:flex-end;">
                                    <button class="add-site-btn-cancel" onclick="clearDateFilter()">Clear</button>
                                    <button class="add-site-btn-save" onclick="applyCustomDateRange()">Apply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete tag modal -->
            <div id="deleteTagModal" class="modal">
                <div class="modal-content add-site-modal-content">
                    <div class="add-site-header">
                        <h2>âš ï¸ Confirm Deletion</h2>
                        <button class="modal-close-btn" onclick="closeDeleteTagModal()">x</button>
                    </div>
                    <div class="delete-info-box">
                        <div class="delete-info-row">
                            <label class="delete-info-label">Tag Name</label>
                            <div class="delete-info-value" id="deleteTagName"></div>
                        </div>
                    </div>
                    <p style="color: #FF6B6B; font-size: 0.9em; margin-top: 16px; font-weight: 500;">âš ï¸ This action
                        cannot be undone</p>
                    <div class="add-site-button-group">
                        <button class="add-site-btn-cancel" id="cancelDeleteTag">Cancel</button>
                        <button class="add-site-btn-save" id="confirmDeleteTag">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Edit category modal -->
            <div id="editCategoryModal" class="modal">
                <div class="modal-content add-site-modal-content" style="max-width: 450px;">
                    <div class="add-site-header">
                        <h2>âœï¸ Edit Category</h2>
                        <button class="modal-close-btn" onclick="closeEditCategoryModal()">x</button>
                    </div>

                    <div id="editCategoryMessage" class="add-site-message"></div>

                    <form id="editCategoryForm">
                        <div class="add-site-form-group">
                            <label for="editCategoryName" class="edit-label">Category Name</label>
                            <input type="text" id="editCategoryName" placeholder="e.g. Productivity" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Color</label>
                            <div class="color-palette">
                                <input type="radio" name="editCategoryColor" id="editCatColor1" value="#667eea"
                                    class="color-radio">
                                <label for="editCatColor1" class="color-swatch" style="background: #667eea;"
                                    title="Purple"></label>

                                <input type="radio" name="editCategoryColor" id="editCatColor2" value="#6CBBFB"
                                    class="color-radio">
                                <label for="editCatColor2" class="color-swatch" style="background: #6CBBFB;"
                                    title="Blue"></label>

                                <input type="radio" name="editCategoryColor" id="editCatColor3" value="#52A69B"
                                    class="color-radio">
                                <label for="editCatColor3" class="color-swatch" style="background: #52A69B;"
                                    title="Teal"></label>
                                <input type="radio" name="editCategoryColor" id="editCatColor4" value="#D98B8B"
                                    class="color-radio">
                                <label for="editCatColor4" class="color-swatch" style="background: #D98B8B;"
                                    title="Coral"></label>
                                <input type="radio" name="editCategoryColor" id="editCatColor5" value="#E0A96D"
                                    class="color-radio">
                                <label for="editCatColor5" class="color-swatch" style="background: #E0A96D;"
                                    title="Orange"></label>
                                <input type="radio" name="editCategoryColor" id="editCatColor6" value="#D98BAC"
                                    class="color-radio">
                                <label for="editCatColor6" class="color-swatch" style="background: #D98BAC;"
                                    title="Pink"></label>
                                <input type="radio" name="editCategoryColor" id="editCatColor7" value="#D4B86A"
                                    class="color-radio">
                                <label for="editCatColor7" class="color-swatch" style="background: #D4B86A;"
                                    title="Yellow"></label>
                            </div>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel" id="cancelEditCategory">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Category modal -->
            <div id="addCategoryModal" class="modal">
                <div class="modal-content add-site-modal-content" style="max-width: 450px;">
                    <div class="add-site-header">
                        <h2>ðŸ“‚ Add Category</h2>
                        <button class="modal-close-btn" onclick="closeAddCategoryModal()">x</button>
                    </div>

                    <div id="addCategoryMessage" class="add-site-message"></div>

                    <form id="addCategoryForm">
                        <div class="add-site-form-group">
                            <label for="addCategoryName" class="edit-label">Category Name</label>
                            <input type="text" id="addCategoryName" placeholder="e.g. Productivity" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Color</label>
                            <div class="color-palette">
                                <input type="radio" name="addCategoryColor" id="addCatColor1" value="#667eea"
                                    class="color-radio">
                                <label for="addCatColor1" class="color-swatch" style="background: #667eea;"
                                    title="Purple"></label>

                                <input type="radio" name="addCategoryColor" id="addCatColor2" value="#6CBBFB"
                                    class="color-radio" checked>
                                <label for="addCatColor2" class="color-swatch" style="background: #6CBBFB;"
                                    title="Blue"></label>

                                <input type="radio" name="addCategoryColor" id="addCatColor3" value="#52A69B"
                                    class="color-radio">
                                <label for="addCatColor3" class="color-swatch" style="background: #52A69B;"
                                    title="Teal"></label>
                                <input type="radio" name="addCategoryColor" id="addCatColor4" value="#D98B8B"
                                    class="color-radio">
                                <label for="addCatColor4" class="color-swatch" style="background: #D98B8B;"
                                    title="Coral"></label>
                                <input type="radio" name="addCategoryColor" id="addCatColor5" value="#E0A96D"
                                    class="color-radio">
                                <label for="addCatColor5" class="color-swatch" style="background: #E0A96D;"
                                    title="Orange"></label>
                                <input type="radio" name="addCategoryColor" id="addCatColor6" value="#D98BAC"
                                    class="color-radio">
                                <label for="addCatColor6" class="color-swatch" style="background: #D98BAC;"
                                    title="Pink"></label>
                                <input type="radio" name="addCategoryColor" id="addCatColor7" value="#D4B86A"
                                    class="color-radio">
                                <label for="addCatColor7" class="color-swatch" style="background: #D4B86A;"
                                    title="Yellow"></label>
                            </div>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel"
                                onclick="closeAddCategoryModal()">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Tag modal -->
            <div id="addTagModal" class="modal">
                <div class="modal-content add-site-modal-content" style="max-width: 450px;">
                    <div class="add-site-header">
                        <h2>ðŸ·ï¸ Add Tag</h2>
                        <button class="modal-close-btn" onclick="closeAddTagModal()">x</button>
                    </div>

                    <div id="addTagMessage" class="add-site-message"></div>

                    <form id="addTagForm">
                        <div class="add-site-form-group">
                            <label for="addTagName" class="edit-label">Tag Name</label>
                            <input type="text" id="addTagName" placeholder="e.g. JavaScript" required>
                        </div>

                        <div class="add-site-form-group">
                            <label class="edit-label">Color</label>
                            <div class="color-palette">
                                <input type="radio" name="addTagColor" id="addTagColor1" value="#667eea"
                                    class="color-radio" checked>
                                <label for="addTagColor1" class="color-swatch" style="background: #667eea;"
                                    title="Purple"></label>

                                <input type="radio" name="addTagColor" id="addTagColor2" value="#6CBBFB"
                                    class="color-radio">
                                <label for="addTagColor2" class="color-swatch" style="background: #6CBBFB;"
                                    title="Blue"></label>

                                <input type="radio" name="addTagColor" id="addTagColor3" value="#52A69B"
                                    class="color-radio">
                                <label for="addTagColor3" class="color-swatch" style="background: #52A69B;"
                                    title="Teal"></label>
                                <input type="radio" name="addTagColor" id="addTagColor4" value="#D98B8B"
                                    class="color-radio">
                                <label for="addTagColor4" class="color-swatch" style="background: #D98B8B;"
                                    title="Coral"></label>
                                <input type="radio" name="addTagColor" id="addTagColor5" value="#E0A96D"
                                    class="color-radio">
                                <label for="addTagColor5" class="color-swatch" style="background: #E0A96D;"
                                    title="Orange"></label>
                                <input type="radio" name="addTagColor" id="addTagColor6" value="#D98BAC"
                                    class="color-radio">
                                <label for="addTagColor6" class="color-swatch" style="background: #D98BAC;"
                                    title="Pink"></label>
                                <input type="radio" name="addTagColor" id="addTagColor7" value="#D4B86A"
                                    class="color-radio">
                                <label for="addTagColor7" class="color-swatch" style="background: #D4B86A;"
                                    title="Yellow"></label>
                            </div>
                        </div>

                        <div class="add-site-button-group">
                            <button type="button" class="add-site-btn-cancel"
                                onclick="closeAddTagModal()">Cancel</button>
                            <button type="submit" class="add-site-btn-save">Save</button>
                        </div>
                    </form>
                </div>
            </div>

        </div> <!-- End dashboardSection -->

        <!-- Supabase SDK -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <script>
            // Multi-select for tags (must be defined before any table rendering)
            var selectedTagIds = new Set();
            var lastSelectedTagIndex = -1;
            // Multi-select for categories
            var selectedCategoryIds = new Set();
            var lastSelectedCategoryIndex = -1;

            function toggleTagRowSelection(event, tagId) {
                if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON') {
                    return;
                }
                const row = event.currentTarget;
                const tagsArray = allTags;
                const currentIndex = tagsArray.findIndex(t => t.id === tagId);
                // Shift+click for range selection
                if (event.shiftKey && lastSelectedTagIndex >= 0) {
                    const start = Math.min(lastSelectedTagIndex, currentIndex);
                    const end = Math.max(lastSelectedTagIndex, currentIndex);
                    for (let i = start; i <= end; i++) {
                        const tag = tagsArray[i];
                        selectedTagIds.add(tag.id);
                        const rowEl = document.querySelector(`tr[data-tag-id="${tag.id}"]`);
                        if (rowEl) rowEl.classList.add('row-selected');
                    }
                } else {
                    if (selectedTagIds.has(tagId)) {
                        selectedTagIds.delete(tagId);
                        row.classList.remove('row-selected');
                    } else {
                        selectedTagIds.add(tagId);
                        row.classList.add('row-selected');
                    }
                    lastSelectedTagIndex = currentIndex;
                }
                updateTagBulkActionBar();
            }
            window.toggleTagRowSelection = toggleTagRowSelection;
            function updateTagBulkActionBar() {
                const bar = document.getElementById('tagBulkActionBar');
                const countEl = document.getElementById('selectedTagCount');
                const selectAllBtn = document.querySelector('#tagBulkActionBar .bulk-btn-select-all');
                const selectAllIcon = document.getElementById('tagSelectAllIcon');
                const count = selectedTagIds.size;
                const totalCount = allTags.length;

                if (countEl) countEl.textContent = count;

                if (selectAllIcon && selectAllBtn) {
                    if (count === 0) {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    } else if (count === totalCount) {
                        selectAllIcon.className = 'fa-solid fa-square-check';
                        selectAllBtn.classList.add('all-selected');
                        selectAllBtn.title = 'Deselect All';
                    } else {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    }
                }

                if (bar) {
                    if (count > 0) bar.classList.add('show'); else bar.classList.remove('show');
                }
            }

            function selectAllTags() {
                const tagsArray = allTags || [];
                if (selectedTagIds.size === tagsArray.length) {
                    clearTagSelection();
                    return;
                }

                tagsArray.forEach(tag => {
                    selectedTagIds.add(tag.id);
                    const rowEl = document.querySelector(`tr[data-tag-id="${tag.id}"]`);
                    if (rowEl) rowEl.classList.add('row-selected');
                });

                updateTagBulkActionBar();
            }

            function bulkEditTags() {
                const count = selectedTagIds.size;
                if (count === 0) return;

                if (count === 1) {
                    const tagId = Array.from(selectedTagIds)[0];
                    const tag = allTags.find(t => String(t.id) === String(tagId)) || {};
                    showEditTagModal(tagId, tag.name || '', tag.color || '#667eea');
                    clearTagSelection();
                } else {
                    showStatus(`âš ï¸ Select only 1 tag to edit (${count} selected)`, 'info');
                }
            }

            function bulkDeleteTags() {
                const count = selectedTagIds.size;
                if (count === 0) return;
                showBulkDeleteTagsModal();
            }

            function showBulkDeleteTagsModal() {
                const count = selectedTagIds.size;
                if (count === 0) return;

                // If exactly one tag is selected, open the tag's detailed delete modal
                if (count === 1) {
                    const id = Array.from(selectedTagIds)[0];
                    const tag = allTags.find(t => String(t.id) === String(id));
                    closeBulkDeleteModal();
                    if (tag) showDeleteTagModal(tag.id, tag.name || '-');
                    return;
                }

                const modal = document.getElementById('bulkDeleteModal');
                const deleteUrlEl = document.getElementById('bulkDeleteUrl');

                let html = '<div class="delete-info-box" style="text-align: center;">';
                html += '<div class="delete-info-row" style="flex-direction: column; align-items: center;">';
                html += '<label class="delete-info-label" style="font-size: 1.08em; font-weight: 600; margin-bottom: 10px;">Tag(s) to be deleted:</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 8px;">';
                for (const tagId of Array.from(selectedTagIds)) {
                    const tag = allTags.find(t => String(t.id) === String(tagId));
                    if (tag) {
                        const tagName = tag.name || '-';
                        const tagColor = tag.color || '#667eea';
                        html += `<span class="delete-info-value" style=" padding: 6px 12px; font-size: 0.95em; font-weight: 600; display: inline-block; background: ${tagColor}20; color: ${tagColor}; border: 1px solid ${tagColor}40; border-radius: 8px; width: fit-content;">${tagName}</span>`;
                    }
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';

                deleteUrlEl.innerHTML = html;
                modal.dataset.type = 'tags';
                modal.classList.add('show');
            }
            function clearTagSelection() {
                selectedTagIds.clear();
                lastSelectedTagIndex = -1;
                document.querySelectorAll('tr[data-tag-id].row-selected').forEach(row => {
                    row.classList.remove('row-selected');
                });
                updateTagBulkActionBar();
            }

            // Expose tag row selection function globally for HTML onclick
            window.toggleTagRowSelection = toggleTagRowSelection;

            // ========== CATEGORY SELECTION FUNCTIONS (TOP-LEVEL) ==========
            function toggleCategoryRowSelection(event, categoryId) {
                // Handle being called from inline handlers where `event` may not be provided, or from programmatic listeners
                const ev = event || window.event;

                // Prefer directly finding the tr for the categoryId (delegation may set currentTarget to the container)
                const explicitRow = document.querySelector(`tr[data-category-id="${categoryId}"]`);
                // If `this` is the row, prefer it; otherwise use the explicitRow
                const row = (this && this.dataset && this.dataset.categoryId === String(categoryId)) ? this : explicitRow;
                if (!row) return;

                // Debugging: log event target to help diagnose clicks
                console.debug('toggleCategoryRowSelection called', { categoryId, target: ev && ev.target && ev.target.tagName, row });

                // Ignore clicks on action buttons (but allow anchor clicks to propagate selection when desired)
                const targetTag = ev && ev.target && ev.target.tagName ? ev.target.tagName : null;
                if (targetTag === 'BUTTON') return;

                const categoriesArray = allCategories || [];
                const currentIndex = categoriesArray.findIndex(c => String(c.id) === String(categoryId));

                // Shift+click range selection â€” operate on tr elements directly
                if (ev && ev.shiftKey && lastSelectedCategoryIndex >= 0 && currentIndex >= 0) {
                    const start = Math.min(lastSelectedCategoryIndex, currentIndex);
                    const end = Math.max(lastSelectedCategoryIndex, currentIndex);
                    for (let i = start; i <= end; i++) {
                        const cat = categoriesArray[i];
                        if (!cat) continue;
                        selectedCategoryIds.add(cat.id);
                        const rowEl = document.querySelector(`tr[data-category-id="${cat.id}"]`);
                        if (rowEl) rowEl.classList.add('row-selected');
                    }
                } else {
                    if (selectedCategoryIds.has(categoryId)) {
                        selectedCategoryIds.delete(categoryId);
                        row.classList.remove('row-selected');
                    } else {
                        selectedCategoryIds.add(categoryId);
                        row.classList.add('row-selected');
                    }
                    lastSelectedCategoryIndex = currentIndex >= 0 ? currentIndex : -1;
                }

                updateCategoryBulkActionBar();
            }

            // Ensure category toggler is available globally
            window.toggleCategoryRowSelection = toggleCategoryRowSelection;

            function updateCategoryBulkActionBar() {
                const bar = document.getElementById('categoryBulkActionBar');
                const countEl = document.getElementById('selectedCategoryCount');
                const selectAllBtn = document.querySelector('#categoryBulkActionBar .bulk-btn-select-all');
                const selectAllIcon = document.getElementById('categorySelectAllIcon');
                const count = selectedCategoryIds.size;
                const totalCount = allCategories.length;

                if (countEl) countEl.textContent = count;

                if (selectAllIcon && selectAllBtn) {
                    if (count === 0) {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    } else if (count === totalCount) {
                        selectAllIcon.className = 'fa-solid fa-square-check';
                        selectAllBtn.classList.add('all-selected');
                        selectAllBtn.title = 'Deselect All';
                    } else {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    }
                }

                if (bar) {
                    if (count > 0) bar.classList.add('show'); else bar.classList.remove('show');
                }
            }

            function clearCategorySelection() {
                selectedCategoryIds.clear();
                lastSelectedCategoryIndex = -1;
                document.querySelectorAll('tr[data-category-id].row-selected').forEach(row => row.classList.remove('row-selected'));
                updateCategoryBulkActionBar();
            }

            function selectAllCategories() {
                const categoriesArray = allCategories || [];
                if (selectedCategoryIds.size === categoriesArray.length) {
                    clearCategorySelection();
                    return;
                }
                categoriesArray.forEach(cat => {
                    selectedCategoryIds.add(cat.id);
                    const rowEl = document.querySelector(`tr[data-category-id="${cat.id}"]`);
                    if (rowEl) rowEl.classList.add('row-selected');
                });
                updateCategoryBulkActionBar();
            }

            // Expose category helpers globally for inline handlers and bindings
            window.toggleCategoryRowSelection = toggleCategoryRowSelection;
            window.selectAllCategories = selectAllCategories;
            window.clearCategorySelection = clearCategorySelection;
            window.bulkDeleteCategories = bulkDeleteCategories;
            window.bulkEditCategories = bulkEditCategories;

            function bulkEditCategories() {
                const count = selectedCategoryIds.size;
                if (count === 0) return;
                if (count === 1) {
                    const categoryId = Array.from(selectedCategoryIds)[0];
                    const cat = allCategories.find(c => String(c.id) === String(categoryId)) || {};
                    showEditCategoryModal(categoryId, cat.name || '', cat.color || '#667eea');
                    clearCategorySelection();
                } else {
                    showStatus(`âš ï¸ Select only 1 category to edit (${count} selected)`, 'info');
                }
            }

            function bulkDeleteCategories() {
                const count = selectedCategoryIds.size;
                if (count === 0) return;
                showBulkDeleteCategoriesModal();
            }

            function showBulkDeleteCategoriesModal() {
                const count = selectedCategoryIds.size;
                if (count === 0) return;

                // If exactly one category is selected, open the detailed delete modal for that category
                if (count === 1) {
                    const id = Array.from(selectedCategoryIds)[0];
                    const cat = allCategories.find(c => String(c.id) === String(id));
                    closeBulkDeleteModal();
                    if (cat) showDeleteCategoryModal(cat.id, cat.name || '-');
                    return;
                }

                const modal = document.getElementById('bulkDeleteModal');
                const deleteUrlEl = document.getElementById('bulkDeleteUrl');

                let html = '<div class="delete-info-box" style="text-align: center;">';
                html += '<div class="delete-info-row" style="flex-direction: column; align-items: center;">';
                html += '<label class="delete-info-label" style="font-size: 1.08em; font-weight: 600; margin-bottom: 10px;">Category(ies) to be deleted:</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 8px;">';
                for (const categoryId of Array.from(selectedCategoryIds)) {
                    const cat = allCategories.find(c => String(c.id) === String(categoryId));
                    if (cat) {
                        const catName = cat.name || '-';
                        const catColor = cat.color || '#6CBBFB';
                        html += `<span class="delete-info-value" style=" padding: 6px 12px; font-size: 0.95em; font-weight: 600; display: inline-block; background: ${catColor}20; color: ${catColor}; border: 1px solid ${catColor}40; border-radius: 8px; width: fit-content;">${catName}</span>`;
                    }
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';

                deleteUrlEl.innerHTML = html;
                modal.dataset.type = 'categories';
                modal.classList.add('show');
            }
            // Close bulk delete modal when clicking outside modal content or pressing ESC
            document.addEventListener('DOMContentLoaded', () => {
                initDatePickers();
                const bulkDeleteModal = document.getElementById('bulkDeleteModal');
                if (bulkDeleteModal) {
                    bulkDeleteModal.addEventListener('mousedown', function (e) {
                        if (e.target === bulkDeleteModal) {
                            closeBulkDeleteModal();
                            if (bulkDeleteModal.dataset.type === 'tags') clearTagSelection();
                            else if (bulkDeleteModal.dataset.type === 'categories') clearCategorySelection();
                            else clearSelection();
                        }
                    });
                    document.addEventListener('keydown', function (e) {
                        if (bulkDeleteModal.classList.contains('show') && e.key === 'Escape') {
                            closeBulkDeleteModal();
                            if (bulkDeleteModal.dataset.type === 'tags') clearTagSelection();
                            else if (bulkDeleteModal.dataset.type === 'categories') clearCategorySelection();
                            else clearSelection();
                        }
                    });
                }

                // Category selection functions removed from DOMContentLoaded: moved to top-level to ensure global availability
            });
            // Confirm bulk delete: delete all selected sites and refresh data
            async function confirmBulkDelete() {
                const modal = document.getElementById('bulkDeleteModal');
                const type = modal && modal.dataset.type ? modal.dataset.type : 'sites';

                if (type === 'categories') {
                    const ids = Array.from(selectedCategoryIds);
                    if (ids.length === 0) return;
                    try {
                        let allSuccess = true;
                        for (const categoryId of ids) {
                            const response = await fetch(`${API_URL}/api/categories/${categoryId}`, { method: 'DELETE' });
                            const data = await response.json();
                            if (!response.ok || !data.success) {
                                allSuccess = false;
                            }
                        }
                        if (allSuccess) {
                            showStatus('âœ… Categories deleted successfully!', 'success');
                        } else {
                            showStatus('âŒ Some categories could not be deleted', 'error');
                        }
                        closeBulkDeleteModal();
                        clearCategorySelection();
                        loadData();
                    } catch (error) {
                        showStatus('âŒ Error deleting categories: ' + error.message, 'error');
                    }

                    return;
                }

                if (type === 'tags') {
                    const ids = Array.from(selectedTagIds);
                    if (ids.length === 0) return;
                    try {
                        let allSuccess = true;
                        for (const tagId of ids) {
                            const response = await fetch(`${API_URL}/api/tags/${tagId}`, { method: 'DELETE' });
                            const data = await response.json();
                            if (!response.ok || !data.success) {
                                allSuccess = false;
                            }
                        }
                        if (allSuccess) {
                            showStatus('âœ… Tags deleted successfully!', 'success');
                        } else {
                            showStatus('âŒ Some tags could not be deleted', 'error');
                        }
                        closeBulkDeleteModal();
                        clearTagSelection();
                        loadData();
                    } catch (error) {
                        showStatus('âŒ Error deleting tags: ' + error.message, 'error');
                    }

                    return;
                }

                // default: delete sites
                const ids = Array.from(selectedSiteIds);
                if (ids.length === 0) return;
                try {
                    let allSuccess = true;
                    for (const siteId of ids) {
                        const response = await fetch(`${API_URL}/api/sites/${siteId}`, { method: 'DELETE' });
                        const data = await response.json();
                        if (!response.ok || !data.success) {
                            allSuccess = false;
                        }
                    }
                    if (allSuccess) {
                        showStatus('âœ… Sites deleted successfully!', 'success');
                    } else {
                        showStatus('âŒ Some sites could not be deleted', 'error');
                    }
                    closeBulkDeleteModal();
                    clearSelection();
                    loadData();
                } catch (error) {
                    showStatus('âŒ Error deleting sites: ' + error.message, 'error');
                }
            }

            // Cancel bulk delete: close modal and clear selection
            function cancelBulkDelete() {
                const modal = document.getElementById('bulkDeleteModal');
                const type = modal && modal.dataset.type ? modal.dataset.type : 'sites';
                closeBulkDeleteModal();
                if (type === 'tags') clearTagSelection();
                else if (type === 'categories') clearCategorySelection();
                else clearSelection();
            }
            function bulkDeleteSites() {
                showBulkDeleteModal();
            }
            window.bulkDeleteSites = bulkDeleteSites;

            // ========== SUPABASE CONFIG ==========
            const SUPABASE_URL = 'https://skacyhzljreaitrbgbte.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrYWN5aHpsanJlYWl0cmJnYnRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NTg2NjksImV4cCI6MjA4MzIzNDY2OX0.KcBnl6l_zg9lTcVgFs2yDq4-F-1TKsyiWGNOoxQ_bdc';

            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            let currentUser = null;

            // ========== AUTH FUNCTIONS ==========
            function showAuthMessage(text, type) {
                const messageEl = document.getElementById('authMessage');
                messageEl.textContent = text;
                messageEl.className = 'auth-message ' + type;
            }

            function hideAuthMessage() {
                const messageEl = document.getElementById('authMessage');
                messageEl.className = 'auth-message';
                messageEl.textContent = '';
            }

            // Login
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const loginBtn = document.getElementById('loginBtn');

                if (!email || !password) {
                    showAuthMessage('Fill in email and password', 'error');
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';

                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) {
                        showAuthMessage(error.message, 'error');
                    } else {
                        currentUser = data.user;
                        showAuthMessage('Successfully logged in!', 'success');
                        setTimeout(() => {
                            showDashboard();
                        }, 500);
                    }
                } catch (err) {
                    showAuthMessage('Error logging in: ' + err.message, 'error');
                }

                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            });

            // Logout
            async function logoutUser() {
                try {
                    await supabaseClient.auth.signOut();
                    currentUser = null;

                    document.getElementById('authSection').classList.remove('hidden');
                    document.getElementById('dashboardSection').classList.add('hidden');
                    showAuthMessage('Successfully logged out!', 'success');
                } catch (err) {
                    console.error('Logout error:', err);
                }
            }

            // Show dashboard after login
            function showDashboard() {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = currentUser?.email || 'User';

                loadData();
            }

            // Check existing session on page load
            async function checkSession() {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session && session.user) {
                        currentUser = session.user;
                        showDashboard();
                    } else {
                        // No active session â€” reveal the login form
                        const authSec = document.getElementById('authSection');
                        if (authSec) authSec.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('Session check error:', err);
                    // On error, reveal the login form so user can still sign in
                    const authSec = document.getElementById('authSection');
                    if (authSec) authSec.classList.remove('hidden');
                }
            }

            // Run session check on load
            checkSession();

            // ========== DASHBOARD SCRIPT ==========
            // Global variable for storing sites
            let allSites = [];
            let selectedSiteIds = new Set(); // Track selected sites for multi-delete
            let lastSelectedIndex = -1; // For shift-click range selection
            let allCategories = [];
            let allTags = [];

            // Multi-select for tags
            var selectedTagIds = new Set();
            var lastSelectedTagIndex = -1;

            const API_URL = 'http://localhost:3000';

            // Date filter state (used by the search filter)
            let dateFilter = { type: 'all', from: null, to: null };

            function toggleDateFilterMenu() {
                // Backwards-compatible toggle: open/close the modal
                const m = document.getElementById('dateFilterModal');
                const t = document.getElementById('dateFilterToggle');
                if (!m) return;
                const isOpen = m.classList.toggle('show');
                if (t) {
                    t.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                    t.classList.toggle('active', isOpen);
                }
            }

            function showDateFilterModal() {
                const m = document.getElementById('dateFilterModal');
                const t = document.getElementById('dateFilterToggle');
                if (!m) return;
                m.classList.add('show');
                // Highlight currently selected preset (if any)
                document.querySelectorAll('#dateFilterModal .date-preset-btn').forEach(b => b.classList.toggle('selected', b.dataset.filterType === dateFilter.type));
                if (t) { t.setAttribute('aria-expanded', 'true'); t.classList.add('active'); }
            }

            function closeDateFilterModal() {
                const m = document.getElementById('dateFilterModal');
                const t = document.getElementById('dateFilterToggle');
                if (!m) return;
                m.classList.remove('show');
                if (t) { t.setAttribute('aria-expanded', 'false'); t.classList.remove('active'); }
            }

            function setDateFilter(type) {
                dateFilter.type = type;
                dateFilter.from = null;
                dateFilter.to = null;
                const label = document.getElementById('dateFilterLabel');
                if (label) label.textContent = type === 'all' ? 'All' : type === 'today' ? 'Today' : type === 'yesterday' ? 'Yesterday' : type === 'week' ? 'Last 7d' : type === 'month' ? 'Last 30d' : type === 'last90' ? 'Last 90d' : 'Custom';
                // Update visual selection for preset buttons
                document.querySelectorAll('#dateFilterModal .date-preset-btn').forEach(b => b.classList.toggle('selected', b.dataset.filterType === type));
                // Close modal and apply
                const m = document.getElementById('dateFilterModal'); if (m) m.classList.remove('show');
                const t = document.getElementById('dateFilterToggle'); if (t) { t.setAttribute('aria-expanded', 'false'); t.classList.remove('active'); }
                filterSites();
            }

            function applyCustomDateRange() {
                const from = document.getElementById('dateFilterFrom')?.value;
                const to = document.getElementById('dateFilterTo')?.value;
                if (!from || !to) { showStatus('âŒ Please select both From and To dates', 'error'); return; }
                const f = new Date(from + 'T00:00:00');
                const tt = new Date(to + 'T23:59:59');
                if (f > tt) { showStatus('âŒ "From" must be before "To"', 'error'); return; }
                dateFilter.type = 'custom';
                dateFilter.from = f;
                dateFilter.to = tt;
                const label = document.getElementById('dateFilterLabel'); if (label) label.textContent = 'Custom';
                // Clear preset selection (custom selected)
                document.querySelectorAll('#dateFilterModal .date-preset-btn').forEach(b => b.classList.remove('selected'));
                const m = document.getElementById('dateFilterModal'); if (m) m.classList.remove('show');
                const t = document.getElementById('dateFilterToggle'); if (t) { t.setAttribute('aria-expanded', 'false'); t.classList.remove('active'); }
                filterSites();
            }

            function clearDateFilter() {
                dateFilter = { type: 'all', from: null, to: null };
                document.getElementById('dateFilterFrom') && (document.getElementById('dateFilterFrom').value = '');
                document.getElementById('dateFilterTo') && (document.getElementById('dateFilterTo').value = '');
                const label = document.getElementById('dateFilterLabel'); if (label) label.textContent = 'All';
                // Set preset visuals to 'all'
                document.querySelectorAll('#dateFilterModal .date-preset-btn').forEach(b => b.classList.toggle('selected', b.dataset.filterType === 'all'));
                const m = document.getElementById('dateFilterModal'); if (m) m.classList.remove('show');
                const t = document.getElementById('dateFilterToggle'); if (t) { t.setAttribute('aria-expanded', 'false'); t.classList.remove('active'); }
                filterSites();
            }

            function initDatePickers() {
                if (typeof flatpickr === 'undefined') return;
                const common = {
                    altInput: true,
                    altFormat: 'd/m/Y',
                    dateFormat: 'Y-m-d',
                    allowInput: true,
                    disableMobile: true,
                    onChange: function (selectedDates, dateStr, instance) {
                        // clear preset selection visually when user picks a custom date
                        document.querySelectorAll('#dateFilterModal .date-preset-btn').forEach(b => b.classList.remove('selected'));
                    }
                };
                try {
                    const modalEl = document.getElementById('dateFilterModal');
                    flatpickr('#dateFilterFrom', Object.assign({}, common, { wrap: false, appendTo: modalEl || document.body }));
                    flatpickr('#dateFilterTo', Object.assign({}, common, { wrap: false, appendTo: modalEl || document.body }));
                } catch (err) {
                    console.warn('Flatpickr init failed', err);
                }
            }

            function isDateInFilter(dateObj) {
                if (!dateFilter || dateFilter.type === 'all') return true;
                const d = new Date(dateObj);
                const today = new Date();
                // normalize to day boundaries when comparing presets
                const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                if (dateFilter.type === 'today') {
                    return d >= startOfToday && d <= new Date(startOfToday.getTime() + 24 * 3600 * 1000 - 1);
                }
                if (dateFilter.type === 'yesterday') {
                    const start = new Date(startOfToday.getTime() - 24 * 3600 * 1000);
                    const end = new Date(startOfToday.getTime() - 1);
                    return d >= start && d <= end;
                }
                if (dateFilter.type === 'week') {
                    const start = new Date(startOfToday.getTime() - 6 * 24 * 3600 * 1000); // last 7 days inclusive
                    return d >= start && d <= new Date(startOfToday.getTime() + 24 * 3600 * 1000 - 1);
                }
                if (dateFilter.type === 'month') {
                    const start = new Date(startOfToday.getTime() - 29 * 24 * 3600 * 1000); // last 30 days inclusive
                    return d >= start && d <= new Date(startOfToday.getTime() + 24 * 3600 * 1000 - 1);
                }
                if (dateFilter.type === 'last90') {
                    const start = new Date(startOfToday.getTime() - 89 * 24 * 3600 * 1000); // last 90 days inclusive
                    return d >= start && d <= new Date(startOfToday.getTime() + 24 * 3600 * 1000 - 1);
                }
                if (dateFilter.type === 'custom' && dateFilter.from && dateFilter.to) {
                    return d >= dateFilter.from && d <= dateFilter.to;
                }
                return true;
            }

            // Optional values for billing
            const PRICING_OPTIONS = [
                { value: 'fully_free', label: 'Fully Free' },
                { value: 'freemium', label: 'Freemium' },
                { value: 'paid', label: 'Paid' },
                { value: 'free_trial', label: 'Free Trial' }
            ];

            // Show status message
            function showStatus(message, type = 'info') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                setTimeout(() => {
                    statusEl.classList.remove('success', 'error', 'info');
                }, 5000);
            }

            function switchTab(tabName, clickedBtn) {
                console.debug('switchTab', { tabName, clickedBtn });
                const allTabs = document.querySelectorAll('.tab-content');
                allTabs.forEach(tab => tab.classList.remove('active'));

                const allButtons = document.querySelectorAll('.tab-button');
                // Hide the category header when switching away from the Sites view
                const catHeader = document.getElementById('categoryHeader');
                if (catHeader) {
                    if (tabName !== 'sites') catHeader.style.display = 'none';
                    else if (!window.currentCategoryName) catHeader.style.display = 'none';
                }
                allButtons.forEach(btn => btn.classList.remove('active'));

                const activeTab = document.getElementById(tabName + 'Tab');
                if (activeTab) activeTab.classList.add('active');
                else console.debug('switchTab: active tab element not found for', tabName);

                // Find the corresponding tab button and mark it active (robust to clicks on inner elements)
                let btn = clickedBtn || document.querySelector(`.tab-button[data-tab="${tabName}"]`) || Array.from(document.querySelectorAll('.tab-button')).find(b => {
                    const on = b.getAttribute('onclick') || '';
                    return on.includes(`switchTab('${tabName}'`) || on.includes(`switchTab(\"${tabName}\"`);
                });

                if (btn && btn.classList) {
                    btn.classList.add('active');
                } else {
                    console.debug('switchTab: tab button not found for', tabName);
                }

                // Update ARIA for accessibility
                try {
                    allButtons.forEach(b => b.setAttribute('aria-selected', b.classList.contains('active') ? 'true' : 'false'));
                } catch (err) { }
            }

            function initializePricingSelect() {
                const pricingSelect = document.getElementById('editPricing');
                pricingSelect.innerHTML = '';

                PRICING_OPTIONS.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.value;
                    optElement.textContent = option.label;
                    pricingSelect.appendChild(optElement);
                });
            }

            // Check server status - compact: update inline dot and show global messages only on state change
            async function checkServerStatus() {
                const serverDot = document.getElementById('serverDot');
                const serverBtn = document.getElementById('serverDotBtn');
                // Set pending while checking
                if (serverDot) {
                    serverDot.className = 'status-dot server-dot-inline pending';
                    serverDot.title = 'Server: Checking...';
                }
                if (serverBtn) serverBtn.title = 'Server: Checking...';

                try {
                    const response = await fetch(`${API_URL}/health`);
                    if (!response.ok) throw new Error('Network response not ok');

                    // Only show global message when state changed
                    if (checkServerStatus._lastState !== 'online') {
                        showStatus('âœ… Server is available!', 'success');
                    }
                    checkServerStatus._lastState = 'online';

                    if (serverDot) {
                        serverDot.className = 'status-dot server-dot-inline online';
                        serverDot.title = 'Server: Online';
                    }
                    if (serverBtn) serverBtn.title = 'Server: Online';
                    return true;
                } catch (error) {
                    if (checkServerStatus._lastState !== 'offline') {
                        showStatus('âŒ Server unavailable at ' + API_URL, 'error');
                    }
                    checkServerStatus._lastState = 'offline';

                    if (serverDot) {
                        serverDot.className = 'status-dot server-dot-inline offline';
                        serverDot.title = 'Server: Offline';
                    }
                    if (serverBtn) serverBtn.title = 'Server: Offline';
                    return false;
                }
            }

            async function loadCategoryData(categoryName) {
                // Normalize/sanitize incoming category name (strip query/hash params)
                const cleanName = String(categoryName || '').replace(/\?.*$/, '').replace(/#.*$/, '').trim();
                showStatus(`Loading sites for category: ${cleanName}...`, 'info');

                document.querySelectorAll('.tab-button').forEach((btn, index) => {
                    if (index === 0) {
                        // Sites tab - show
                        btn.style.display = 'inline-block';
                        btn.classList.add('active');
                    } else {
                        // Categories i Tags tab - hide
                        btn.style.display = 'none';
                        btn.classList.remove('active');
                    }
                });

                // Hide entire tabs header when viewing category
                const tabsHeader = document.querySelector('.tabs-header');
                if (tabsHeader) tabsHeader.style.display = 'none';

                const sitesTab = document.getElementById('sitesTab');
                const categoriesTab = document.getElementById('categoriesTab');
                const tagsTab = document.getElementById('tagsTab');

                if (sitesTab) sitesTab.classList.add('active');
                if (categoriesTab) categoriesTab.classList.remove('active');
                if (tagsTab) tagsTab.classList.remove('active');

                try {
                    const response = await fetch(`${API_URL}/api/category/${encodeURIComponent(cleanName)}/sites`);
                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        showStatus('âŒ Error loading category: ' + (data.error || 'Unknown error'), 'error');
                        return;
                    }

                    const oldHeading = document.getElementById('categoryHeading');
                    if (oldHeading) oldHeading.remove();

                    const oldBtn = document.getElementById('backToDashboardBtn');
                    if (oldBtn) oldBtn.remove();

                    // Display category name as heading ABOVE search bar
                    const heading = document.createElement('div');
                    heading.id = 'categoryHeading';
                    heading.style.marginBottom = '20px';
                    heading.style.marginTop = '0';
                    heading.style.display = 'flex';
                    heading.style.alignItems = 'center';
                    heading.style.gap = '10px';
                    if (typeof backBtn === 'undefined' || backBtn === null) { var backBtn = document.createElement('button'); backBtn.id = 'backToDashboardBtn'; }
                    backBtn.textContent = 'â† Back';
                    backBtn.className = 'btn-add';
                    backBtn.style.backgroundColor = '#1A2E52';
                    backBtn.style.color = '#6CBBFB';
                    backBtn.onclick = () => {
                        window.location.href = 'http://localhost:3000/dashboard.html';
                    };

                    const backBtnWrapper = document.querySelector('#sitesTab .search-bar-wrapper').parentElement;
                    if (backBtnWrapper) {
                        backBtnWrapper.style.justifyContent = 'space-between';
                        // Create or reuse a left-aligned group so Back + bulk buttons sit next to each other
                        let leftGroup = backBtnWrapper.querySelector('.left-controls-group');
                        if (!leftGroup) {
                            leftGroup = document.createElement('div');
                            leftGroup.className = 'left-controls-group';
                            leftGroup.style.display = 'flex';
                            leftGroup.style.alignItems = 'center';
                            leftGroup.style.gap = '8px';
                        }
                        if (backBtnWrapper.firstChild !== leftGroup) backBtnWrapper.insertBefore(leftGroup, backBtnWrapper.firstChild);

                        // Move Back button and bulk bar into the left group so they are adjacent
                        leftGroup.appendChild(backBtn);
                        const bulkBar = document.getElementById('bulkActionBar');
                        if (bulkBar) leftGroup.appendChild(bulkBar);
                    }

                    // Store category context (sanitized) and render only category sites
                    window.currentCategoryName = cleanName;
                    window.currentCategorySites = (data && data.data) ? data.data : [];
                    // Show/update category header
                    const catHeader = document.getElementById('categoryHeader');
                    if (catHeader) catHeader.style.display = 'flex';
                    // header text will be set below (combined name + count)

                    // Clear previous selections and render the category sites
                    clearSelection(); clearTagSelection(); clearCategorySelection();
                    renderSites(window.currentCategorySites);

                    // Update sites counter to reflect category
                    const sitesCountEl = document.getElementById('sitesTableCount');
                    if (sitesCountEl) sitesCountEl.textContent = window.currentCategorySites.length || 0;
                    // Put the category name into its span and the count into the badge (do not destroy child spans)
                    const nameEl = document.getElementById('currentCategoryName');
                    if (nameEl) nameEl.textContent = window.currentCategoryName || '';
                    const countEl = document.getElementById('currentCategoryCount');
                    if (countEl) countEl.textContent = (window.currentCategorySites.length || 0);

                    showStatus('âœ… Category data loaded!', 'success');
                } catch (error) {
                    showStatus('âŒ Error loading category data: ' + error.message, 'error');
                    console.error(error);
                }
            }

            // Load all data
            async function loadData() {
                // Clear any selection when reloading
                clearSelection(); clearTagSelection(); clearCategorySelection(); showStatus('Loading data...', 'info');

                // Check if URL has category
                const urlPath = window.location.pathname;
                const categoryMatch = urlPath.match(/\/category\/(.+?)(?:\?|\/|$)/);

                if (categoryMatch) {
                    const categoryName = decodeURIComponent(categoryMatch[1]);
                    loadCategoryData(categoryName);
                    const tabsHeader = document.querySelector('.tabs-header');
                    if (tabsHeader) tabsHeader.style.display = 'none';
                    return;
                }

                const tabsHeader = document.querySelector('.tabs-header');
                if (tabsHeader) tabsHeader.style.display = 'flex';

                // Delete global category variable
                delete window.currentCategoryName; // leaving header hide/clear to follow-up code
                // Hide category header
                const catHeader = document.getElementById('categoryHeader');
                if (catHeader) catHeader.style.display = 'none';
                const catNameEl = document.getElementById('currentCategoryName');
                const headerTextEl = document.getElementById('categoryHeaderText');
                if (catNameEl) catNameEl.textContent = '';
                const countEl = document.getElementById('currentCategoryCount');
                if (countEl) countEl.textContent = '0';

                try {
                    const [sites, categories, tags, stats] = await Promise.all([
                        fetch(`${API_URL}/api/sites`).then(r => r.json()),
                        fetch(`${API_URL}/api/categories`).then(r => r.json()),
                        fetch(`${API_URL}/api/tags`).then(r => r.json()),
                        fetch(`${API_URL}/api/stats`).then(r => r.json())
                    ]);

                    document.getElementById('sitesTableCount').textContent = stats.stats?.sites || 0;
                    document.getElementById('categoriesTableCount').textContent = stats.stats?.categories || 0;
                    document.getElementById('tagsTableCount').textContent = stats.stats?.tags || 0;

                    renderSites(sites.data || []);
                    allSites = sites.data || [];
                    allCategories = categories.data || [];
                    allTags = tags.data || [];
                    renderCategories(categories.data || []);
                    renderTags(tags.data || []);

                    showStatus('âœ… Data loaded successfully!', 'success');
                } catch (error) {
                    showStatus('âŒ Error loading data: ' + error.message, 'error');
                    console.error(error);
                }
            }

            async function syncData() {
                showStatus('Syncing with Supabase...', 'info');
                updateSyncBadge('pending');

                try {
                    const response = await fetch(`${API_URL}/api/export/all`);
                    const data = await response.json();

                    if (data.success) {
                        // Update table counts
                        if (document.getElementById('sitesTableCount')) {
                            document.getElementById('sitesTableCount').textContent = data.data.stats.total_sites;
                        }
                        if (document.getElementById('categoriesTableCount')) {
                            document.getElementById('categoriesTableCount').textContent = data.data.stats.total_categories;
                        }
                        if (document.getElementById('tagsTableCount')) {
                            document.getElementById('tagsTableCount').textContent = data.data.stats.total_tags;
                        }

                        showStatus('âœ… Sync successful!', 'success');
                        updateSyncBadge('success', new Date());
                        // Refresh local data shortly after sync completes
                        setTimeout(() => loadData(), 250);
                    }
                } catch (error) {
                    showStatus('âŒ Error syncing: ' + error.message, 'error');
                    updateSyncBadge('error', new Date());
                }
            }

            async function exportData() {
                try {
                    const response = await fetch(`${API_URL}/api/export/all`);
                    const data = await response.json();

                    const jsonString = JSON.stringify(data.data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `site-organizer-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();

                    showStatus('âœ… Data downloaded!', 'success');
                } catch (error) {
                    showStatus('âŒ Download error: ' + error.message, 'error');
                }
            }

            // Export selected data as CSV (sites list)
            async function exportDataCSV() {
                try {
                    const response = await fetch(`${API_URL}/api/export/all`);
                    const data = await response.json();

                    const sites = (data && data.data && data.data.sites) ? data.data.sites : (Array.isArray(data && data.data) ? data.data : []);

                    if (!sites || sites.length === 0) {
                        showStatus('âŒ No site data available for CSV export', 'error');
                        return;
                    }

                    const headers = ['id', 'name', 'url', 'categories', 'tags', 'pricing', 'created_at'];
                    const rows = sites.map(s => {
                        const categories = s.categories_array ? s.categories_array.map(c => (typeof c === 'string' ? c : c.name)).join('|') : (s.category || '');
                        const tags = s.tags_array ? s.tags_array.map(t => (typeof t === 'string' ? t : t.name)).join('|') : (s.tags || '');
                        return {
                            id: s.id || '',
                            name: s.name || '',
                            url: s.url || '',
                            categories,
                            tags,
                            pricing: s.pricing || '',
                            created_at: s.created_at || ''
                        };
                    });

                    const csvLines = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] || '')).join(',')));
                    const csvString = csvLines.join('\r\n');

                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `site-organizer-sites-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();

                    showStatus('âœ… CSV downloaded!', 'success');
                } catch (error) {
                    showStatus('âŒ CSV download error: ' + error.message, 'error');
                }
            }

            function renderSites(sites) {
                const container = document.getElementById('sitesContainer');
                if (sites.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No sites</p></div>';
                    return;
                }

                function formatPricing(pricing) {
                    const pricingMap = {
                        'fully_free': 'Fully Free',
                        'paid': 'Paid',
                        'free_trial': 'Free Trial',
                        'freemium': 'Freemium'
                    };
                    return pricingMap[pricing] || pricing || '-';
                }

                let html = '<table><thead><tr><th onclick="sortTable(\'sitesContainer\', 0, \'sites\')">Name <span class="sort-icon inactive"></span></th><th>URL</th><th onclick="sortTable(\'sitesContainer\', 2, \'sites\')">Category <span class="sort-icon inactive"></span></th><th onclick="sortTable(\'sitesContainer\', 3, \'sites\')">Tags <span class="sort-icon inactive"></span></th><th>Pricing</th><th onclick="sortTable(\'sitesContainer\', 5, \'sites\')">Created <span class="sort-icon inactive"></span></th></tr></thead><tbody>';
                sites.forEach(site => {
                    let categoryName = '-';
                    // Show all categories as colored badges (similar to tags)
                    if (site.categories_array && site.categories_array.length > 0) {
                        // Filter out deleted categories and show only existing ones
                        categoryName = site.categories_array
                            .filter(c => {
                                const catName = typeof c === 'string' ? c : c.name;
                                return allCategories.some(allCat => allCat.name === catName);
                            })
                            .map(c => {
                                const catName = typeof c === 'string' ? c : c.name;
                                const catColor = (typeof c === 'object' && c.color) ? c.color : '#6CBBFB';
                                return `<span class="tag-badge" style="background: ${catColor}20; color: ${catColor}; border: 1px solid ${catColor}40;">${catName}</span>`;
                            }).join(' ');
                    } else if (site.categories_array && site.categories_array[0]) {
                        const cat = site.categories_array[0];
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        const catColor = (typeof cat === 'object' && cat.color) ? cat.color : '#6CBBFB';
                        categoryName = `<span class="tag-badge" style="background: ${catColor}; color: white;">${catName}</span>`;
                    } else if (site.category) {
                        categoryName = `<span class="tag-badge" style="background: #6CBBFB20; color: #6CBBFB; border: 1px solid #6CBBFB40;">${site.category}</span>`;
                    }

                    // Display tags as colored badges
                    let tagsHtml = '-';
                    if (site.tags_array && site.tags_array.length > 0) {
                        // Filter out deleted tags and show only existing ones
                        tagsHtml = site.tags_array
                            .filter(t => {
                                const tagName = typeof t === 'string' ? t : t.name;
                                return allTags.some(allTag => allTag.name === tagName);
                            })
                            .map(t => {
                                const tagName = typeof t === 'string' ? t : t.name;
                                const tagColor = (typeof t === 'object' && t.color) ? t.color : '#667eea';
                                return `<span class="tag-badge" style="background: ${tagColor}20; color: ${tagColor}; border: 1px solid ${tagColor}40;">${tagName}</span>`;
                            }).join(' ');
                        // If all tags were filtered out, show dash
                        if (!tagsHtml) tagsHtml = '-';
                    } else if (site.tags && typeof site.tags === 'string') {
                        tagBadges = `<span class="tag-badge" style="background: #667eea20; color: #667eea; border: 1px solid #667eea40;">${site.tags}</span>`;
                    }
                    const pricingFormatted = formatPricing(site.pricing);
                    const siteName = site.name || '-';

                    // Create pricing badge with appropriate class
                    const pricingClass = site.pricing ? `pricing-badge ${site.pricing.replace(/_/g, '-')}` : 'pricing-badge';

                    const isSelected = selectedSiteIds.has(site.id);
                    html += `<tr data-site-id="${site.id}" data-created="${site.created_at}" class="${isSelected ? 'row-selected' : ''}" onclick="toggleRowSelection(event, '${site.id}')">
                    <td>${siteName}</td>
                    <td><a href="${site.url}" target="_blank" title="${site.url}" onclick="event.stopPropagation()">${site.url}</a></td>
                    <td>${categoryName}</td>
                    <td>${tagsHtml}</td>
                    <td><span class="${pricingClass}">${pricingFormatted}</span></td>
                    <td>${new Date(site.created_at).toLocaleDateString('sr-RS')}</td>
                </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function renderCategories(categories) {
                const container = document.getElementById('categoriesContainer');
                if (categories.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No categories</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th onclick="sortTable(\'categoriesContainer\', 0, \'categories\')">Name <span class="sort-icon inactive"></span></th><th>Color</th></tr></thead><tbody>';
                categories.forEach(cat => {
                    const isSelected = selectedCategoryIds && selectedCategoryIds.has && selectedCategoryIds.has(cat.id);
                    html += `<tr data-category-id="${cat.id}" class="${isSelected ? 'row-selected' : ''}">
                    <td><a href="javascript:void(0)" onclick="loadCategoryData('${cat.name}'); return false;" style="text-decoration: none;"><span class="tag-badge" style="background: ${cat.color || '#6CBBFB'}20; color: ${cat.color || '#6CBBFB'}; border: 1px solid ${cat.color || '#6CBBFB'}40;">${cat.name}</span></a></td>
                    <td><span style="width: 20px; height: 20px; background: ${cat.color || '#ccc'}; display: inline-block; border-radius: 3px;"></span></td>
                </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Selection is handled by a single delegated listener on #categoriesContainer to avoid duplicate calls.
            }

            function renderTags(tags) {
                const container = document.getElementById('tagsContainer');
                if (tags.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No tags</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th onclick="sortTable(\'tagsContainer\', 0, \'tags\')">Tag <span class="sort-icon inactive"></span></th><th>Color</th></tr></thead><tbody>';
                tags.forEach(tag => {
                    const isSelected = selectedTagIds && selectedTagIds.has && selectedTagIds.has(tag.id);
                    html += `<tr data-tag-id="${tag.id}" class="${isSelected ? 'row-selected' : ''}">
                    <td><span class="tag-badge" style="background: ${tag.color || '#667eea'}20; color: ${tag.color || '#667eea'}; border: 1px solid ${tag.color || '#667eea'}40;">${tag.name}</span></td>
                    <td><span style="width: 20px; height: 20px; background: ${tag.color || '#667eea'}; display: inline-block; border-radius: 3px;"></span></td>
                </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Attach click listeners to rows after HTML insertion so handler exists
                container.querySelectorAll('tbody tr[data-tag-id]').forEach(row => {
                    row.addEventListener('click', function (e) {
                        toggleTagRowSelection.call(this, e, this.dataset.tagId);
                    });
                });
            }

            // Show delete modal with all data from row
            function showDeleteModal(siteId) {
                const modal = document.getElementById('deleteModal');
                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;
                const site = sitesArray.find(s => s.id === siteId);

                if (!site) return;

                // Display all data
                const siteName = site.name || '-';
                const siteUrl = site.url || '-';

                // Format categories as styled badges
                let categoryBadges = '-';
                if (site.categories_array && site.categories_array.length > 0) {
                    categoryBadges = site.categories_array
                        .filter(c => {
                            const catName = typeof c === 'string' ? c : c.name;
                            return allCategories.some(allCat => allCat.name === catName);
                        })
                        .map(c => {
                            const catName = typeof c === 'string' ? c : c.name;
                            const catColor = (typeof c === 'object' && c.color) ? c.color : '#6CBBFB';
                            return `<span class="tag-badge" style="background: ${catColor}20; color: ${catColor}; border: 1px solid ${catColor}40; cursor: not-allowed;">${catName}</span>`;
                        }).join(' ');
                    if (!categoryBadges) categoryBadges = '-';
                } else if (site.category) {
                    categoryBadges = `<span class="tag-badge" style="background: #6CBBFB20; color: #6CBBFB; border: 1px solid #6CBBFB40; cursor: not-allowed;">${site.category}</span>`;
                }

                // Format tags as styled badges
                let tagBadges = '-';
                if (site.tags_array && site.tags_array.length > 0) {
                    tagBadges = site.tags_array
                        .filter(t => {
                            const tagName = typeof t === 'string' ? t : t.name;
                            return allTags.some(allTag => allTag.name === tagName);
                        })
                        .map(t => {
                            const tagName = typeof t === 'string' ? t : t.name;
                            const tagColor = (typeof t === 'object' && t.color) ? t.color : '#667eea';
                            return `<span class="tag-badge" style="background: ${tagColor}20; color: ${tagColor}; border: 1px solid ${tagColor}40; cursor: not-allowed;">${tagName}</span>`;
                        }).join(' ');
                    if (!tagBadges) tagBadges = '-';
                } else if (site.tags && typeof site.tags === 'string') {
                    tagBadges = `<span class="tag-badge" style="background: #667eea20; color: #667eea; border: 1px solid #667eea40; cursor: not-allowed;">${site.tags}</span>`;
                }
                const pricingMap = {
                    'fully_free': 'Fully Free',
                    'paid': 'Paid',
                    'free_trial': 'Free Trial',
                    'freemium': 'Freemium'
                };
                const pricingFormatted = pricingMap[site.pricing] || site.pricing || '-';
                const createdDate = new Date(site.created_at).toLocaleDateString('en-US');

                // Update delete URL element with all data as readonly fields
                const deleteUrlEl = document.getElementById('deleteUrl');
                deleteUrlEl.innerHTML = `
                    <div class="delete-info-box">
                        <div class="delete-info-row">
                            <label class="delete-info-label">Site Name</label>
                            <div class="delete-info-value" readonly>${siteName}</div>
                        </div>
                        <div class="delete-info-row">
                            <label class="delete-info-label">URL Address</label>
                            <a href="${siteUrl}" target="_blank" class="delete-info-value delete-url-link">${siteUrl}</a>
                        </div>
                        <div class="delete-info-row">
                            <label class="delete-info-label">Category</label>
                            <div class="delete-info-value" style="display: flex; flex-wrap: wrap; gap: 6px;">${categoryBadges}</div>
                        </div>
                        <div class="delete-info-row">
                            <label class="delete-info-label">Tags</label>
                            <div class="delete-info-value" style="display: flex; flex-wrap: wrap; gap: 6px;">${tagBadges}</div>
                        </div>
                        <div class="delete-info-row two-column">
                            <div>
                                <label class="delete-info-label">Pricing Model</label>
                                <div class="delete-info-value" readonly><span class="pricing-badge ${site.pricing ? site.pricing.replace(/_/g, '-') : ''}">${pricingFormatted}</span></div>
                            </div>
                            <div>
                                <label class="delete-info-label">Created</label>
                                <div class="delete-info-value" readonly>${createdDate}</div>
                            </div>
                        </div>
                    </div>
                    <p style="color: #FF6B6B; font-size: 0.9em; margin-top: 16px; font-weight: 500;">âš ï¸ This action cannot be undone</p>
                `;

                // Save site ID for later use
                modal.dataset.siteId = siteId;
                modal.classList.add('show');
            }

            function closeDeleteModal() {
                const modal = document.getElementById('deleteModal');
                modal.classList.remove('show');
                delete modal.dataset.siteId;
            }

            // ========== MULTI-SELECT FUNCTIONS ==========
            function toggleRowSelection(event, siteId) {
                // Don't select if clicking on links or buttons
                if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON') {
                    return;
                }

                const row = event.currentTarget;
                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;
                const currentIndex = sitesArray.findIndex(s => s.id === siteId);

                // Shift+click for range selection
                if (event.shiftKey && lastSelectedIndex >= 0) {
                    const start = Math.min(lastSelectedIndex, currentIndex);
                    const end = Math.max(lastSelectedIndex, currentIndex);

                    for (let i = start; i <= end; i++) {
                        const site = sitesArray[i];
                        selectedSiteIds.add(site.id);
                        const rowEl = document.querySelector(`tr[data-site-id="${site.id}"]`);
                        if (rowEl) rowEl.classList.add('row-selected');
                    }
                } else {
                    // Toggle single selection
                    if (selectedSiteIds.has(siteId)) {
                        selectedSiteIds.delete(siteId);
                        row.classList.remove('row-selected');
                    } else {
                        selectedSiteIds.add(siteId);
                        row.classList.add('row-selected');
                    }
                    lastSelectedIndex = currentIndex;
                }

                updateBulkActionBar();
            }

            function updateBulkActionBar() {
                const bar = document.getElementById('bulkActionBar');
                const countEl = document.getElementById('selectedCount');
                const selectAllBtn = document.querySelector('.bulk-btn-select-all');
                const selectAllIcon = document.getElementById('selectAllIcon');
                const count = selectedSiteIds.size;
                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;
                const totalCount = sitesArray.length;

                countEl.textContent = count;

                // Update select all icon based on state
                if (selectAllIcon && selectAllBtn) {
                    if (count === 0) {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    } else if (count === totalCount) {
                        selectAllIcon.className = 'fa-solid fa-square-check';
                        selectAllBtn.classList.add('all-selected');
                        selectAllBtn.title = 'Deselect All';
                    } else {
                        selectAllIcon.className = 'fa-regular fa-square-minus';
                        selectAllBtn.classList.remove('all-selected');
                        selectAllBtn.title = 'Select All';
                    }
                }

                if (count > 0) {
                    bar.classList.add('show');
                } else {
                    bar.classList.remove('show');
                }
            }

            function clearSelection() {
                selectedSiteIds.clear();
                lastSelectedIndex = -1;
                document.querySelectorAll('tr.row-selected').forEach(row => {
                    row.classList.remove('row-selected');
                });
                updateBulkActionBar();
            }

            function selectAllSites() {
                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;

                // If all are already selected, deselect all
                if (selectedSiteIds.size === sitesArray.length) {
                    clearSelection();
                    return;
                }

                // Select all
                sitesArray.forEach(site => {
                    selectedSiteIds.add(site.id);
                    const rowEl = document.querySelector(`tr[data-site-id="${site.id}"]`);
                    if (rowEl) rowEl.classList.add('row-selected');
                });

                updateBulkActionBar();
            }

            function bulkEditSites() {
                const count = selectedSiteIds.size;
                if (count === 0) return;

                if (count === 1) {
                    // Single selection - open edit modal directly
                    const siteId = Array.from(selectedSiteIds)[0];
                    showEditModal(siteId);
                    clearSelection();
                } else {
                    // Multiple selection - show message
                    showStatus(`âš ï¸ Select only 1 site to edit (${count} selected)`, 'info');
                }
            }

            function showBulkDeleteModal() {
                const count = selectedSiteIds.size;
                if (count === 0) return;

                // If exactly one site is selected, show the full delete modal (detailed view)
                if (count === 1) {
                    const ids = Array.from(selectedSiteIds);
                    const siteId = ids[0];
                    // Clear bulk selection UI and close bulk modal if it was open, then open single delete modal
                    closeBulkDeleteModal();
                    showDeleteModal(siteId);
                    return;
                }

                const modal = document.getElementById('bulkDeleteModal');
                const deleteUrlEl = document.getElementById('bulkDeleteUrl');

                let html = '';
                const ids = Array.from(selectedSiteIds);
                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;

                // Improved UI: show site names as badges, center content, and only one warning
                html += '<div class="delete-info-box" style="text-align: center;">';
                html += '<div class="delete-info-row" style="flex-direction: column; align-items: center;">';
                html += '<label class="delete-info-label" style="font-size: 1.08em; font-weight: 600; margin-bottom: 10px;">Site(s) to be deleted:</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 8px;">';
                for (const siteId of ids) {
                    const site = sitesArray.find(s => s.id === siteId);
                    if (site) {
                        const siteName = site.name || '-';
                        html += `<span class="delete-info-value" style=" padding: 6px 16px; font-size: 1em; font-weight: 600; display: inline-block; letter-spacing: 0.01em; width:max-content;">${siteName}</span>`;
                    }
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';

                deleteUrlEl.innerHTML = html;
                modal.dataset.type = 'sites';
                modal.classList.add('show');
            }

            function closeBulkDeleteModal() {
                const modal = document.getElementById('bulkDeleteModal');
                modal.classList.remove('show');
            }


            // Delete site
            async function deleteSite() {
                const modal = document.getElementById('deleteModal');
                const siteId = modal.dataset.siteId;

                if (!siteId) return;

                try {
                    const response = await fetch(`${API_URL}/api/sites/${siteId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('âœ… Site deleted successfully!', 'success');
                        closeDeleteModal();
                        loadData(); // Refresh data
                    } else {
                        showStatus('âŒ Error deleting: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error deleting: ' + error.message, 'error');
                }
            }

            // Show modal for editing
            function showEditModal(siteId) {
                const modal = document.getElementById('editModal');

                const sitesArray = window.currentCategoryName && window.currentCategorySites ? window.currentCategorySites : allSites;
                const site = sitesArray.find(s => s.id === siteId);
                if (!site) {
                    showStatus('Website not found', 'error');
                    return;
                }

                // Set Name
                document.getElementById('editName').value = site.name || '';

                // Set URL
                document.getElementById('editUrl').value = site.url;

                // Create and populate category checkboxes
                const categoriesList = document.getElementById('editCategoriesCheckboxList');
                categoriesList.innerHTML = '';
                allCategories.forEach((cat, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'add-site-checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `editCat_${index}_${cat.id} `;
                    checkbox.value = cat.id;
                    // Check if category is in site's categories
                    checkbox.checked = (site.categories_array || []).some(c => String(c.id) === String(cat.id));

                    // On category page, even if no more categories, show current
                    if (window.currentCategoryName && cat.name === window.currentCategoryName && !checkbox.checked) {
                        checkbox.checked = true;
                    }


                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = cat.name;

                    const catColor = cat.color || '#6CBBFB';
                    itemDiv.style.background = catColor + '20';
                    itemDiv.style.color = catColor;
                    itemDiv.style.border = '1px solid ' + catColor + '40';
                    label.style.color = catColor;

                    itemDiv.onclick = (e) => {
                        checkbox.checked = !checkbox.checked;

                        if (checkbox.checked) {
                            itemDiv.style.outline = '1px solid ' + catColor;
                            itemDiv.style.outlineOffset = '2px';
                            itemDiv.style.fontWeight = '700';
                        } else {
                            itemDiv.style.outline = 'none';
                            itemDiv.style.fontWeight = '600';
                        }
                    };

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    categoriesList.appendChild(itemDiv);
                });

                // Create and populate tag checkboxes
                const tagsList = document.getElementById('editTagsCheckboxList');
                tagsList.innerHTML = '';

                // Use site.tags (strings) instead of tags_array
                const siteTags = site.tags_array || site.tags || [];

                allTags.forEach((tag, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'add-site-checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `editTag_${index}_${tag.id} `;
                    checkbox.value = tag.id;

                    // Check if tag is in array - by ID if object, by name if string
                    const isChecked = siteTags.some(t => {
                        if (typeof t === 'string') {
                            // If tags are strings, compare by name
                            return t === tag.name;
                        } else {
                            return t.id && String(t.id) === String(tag.id);
                        }
                    });

                    checkbox.checked = isChecked;

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = tag.name;

                    const tagColor = tag.color || '#667eea';
                    itemDiv.style.background = tagColor + '20';
                    itemDiv.style.color = tagColor;
                    itemDiv.style.border = '1px solid ' + tagColor + '40';
                    label.style.color = tagColor;

                    itemDiv.onclick = (e) => {
                        checkbox.checked = !checkbox.checked;

                        if (checkbox.checked) {
                            itemDiv.style.outline = '1px solid ' + tagColor;
                            itemDiv.style.outlineOffset = '2px';
                            itemDiv.style.fontWeight = '700';
                        } else {
                            itemDiv.style.outline = 'none';
                            itemDiv.style.fontWeight = '600';
                        }
                    };

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    tagsList.appendChild(itemDiv);
                });

                initializePricingSelect();
                document.getElementById('editPricing').value = site.pricing || '';

                modal.dataset.siteId = siteId;
                modal.classList.add('show');
            }

            function closeEditModal() {
                const modal = document.getElementById('editModal');
                modal.classList.remove('show');
                document.getElementById('editForm').reset();
                delete modal.dataset.siteId;
            }

            // Save site changes
            async function saveEditedSite(e) {
                e.preventDefault();

                const modal = document.getElementById('editModal');
                const siteId = modal.dataset.siteId;
                if (!siteId) return;

                const name = document.getElementById('editName').value.trim();
                const url = document.getElementById('editUrl').value.trim();
                const pricing = document.getElementById('editPricing').value;

                if (!name || !url || !pricing) {
                    showStatus('Name, URL and pricing model are required', 'error');
                    return;
                }

                // Collect selected category names
                const categoryElements = Array.from(document.querySelectorAll('#editCategoriesCheckboxList input[type="checkbox"]:checked'));
                const categories = categoryElements.map(el => {
                    const categoryId = el.value;
                    const foundCat = allCategories.find(c => String(c.id) === String(categoryId));
                    return foundCat?.name || '';
                }).filter(name => name);

                // Collect selected tag IDs and convert to tag names
                const tagElements = Array.from(document.querySelectorAll('#editTagsCheckboxList input[type="checkbox"]:checked'));
                const tag_ids = tagElements.map(el => el.value).filter(id => id);

                // Convert tag IDs to tag names
                const tags = tag_ids.map(id => {
                    const foundTag = allTags.find(t => String(t.id) === String(id));
                    return foundTag?.name || '';
                }).filter(name => name);

                // Validation - check if categories are selected
                if (!categories || categories.length === 0) {
                    showStatus('âŒ At least one category must be selected', 'error');
                    return;
                }

                if (!tags || tags.length === 0) {
                    showStatus('âŒ You must choose at least one tag', 'error');
                    return;
                }


                try {
                    const response = await fetch(`${API_URL}/api/sites/${siteId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            url,
                            categories: categories,
                            tags: tags,
                            pricing,
                            user_id: currentUser?.id
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('â³ Refreshing data...', 'info');
                        closeEditModal();

                        // Wait a bit for tags to reach Supabase before loading
                        setTimeout(() => {
                            loadData().then(() => {
                                showStatus('âœ… Site successfully updated!', 'success');
                            }).catch(err => {
                                console.error('âŒ Error:', err);
                                showStatus('âŒ Error refreshing', 'error');
                            });
                        }, 500);
                    } else {
                        showStatus('âŒ Error updating: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error updating: ' + error.message, 'error');
                }
            }

            // Show category delete modal
            function showDeleteCategoryModal(categoryId, categoryName) {
                const modal = document.getElementById('deleteCategoryModal');
                const nameEl = document.getElementById('deleteCategoryName');
                nameEl.textContent = categoryName;

                modal.dataset.categoryId = categoryId;
                modal.classList.add('show');
            }

            function closeDeleteCategoryModal() {
                const modal = document.getElementById('deleteCategoryModal');
                modal.classList.remove('show');
                delete modal.dataset.categoryId;
            }

            // Delete category
            async function deleteCategory() {
                const modal = document.getElementById('deleteCategoryModal');
                const categoryId = modal.dataset.categoryId;

                if (!categoryId) return;

                try {
                    const response = await fetch(`${API_URL}/api/categories/${categoryId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('âœ… Category successfully deleted!', 'success');
                        closeDeleteCategoryModal();
                        loadData();
                    } else {
                        showStatus('âŒ Error while deleting: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error while deleting: ' + error.message, 'error');
                }
            }

            // ========== TAG EDIT/DELETE FUNCTIONS ==========
            // Show modal for editing a tag
            function showEditTagModal(tagId, tagName, tagColor) {
                const modal = document.getElementById('editTagModal');

                if (!modal) {
                    console.error('editTagModal not found');
                    return;
                }

                const color = tagColor || '#667eea';
                document.getElementById('editTagName').value = tagName;

                // Set the radio button for the matching color
                const colorRadio = document.querySelector(`input[name = "editTagColor"][value = "${color}"]`);
                if (colorRadio) {
                    colorRadio.checked = true;
                } else {
                    // Default to first color if no match
                    document.getElementById('editTagColor1').checked = true;
                }

                modal.dataset.tagId = tagId;
                modal.classList.add('show');
            }

            function closeEditTagModal() {
                const modal = document.getElementById('editTagModal');
                if (modal) {
                    modal.classList.remove('show');
                    document.getElementById('editTagForm').reset();
                    delete modal.dataset.tagId;
                }
            }

            // Save tag changes
            async function saveEditedTag(e) {
                e.preventDefault();

                const modal = document.getElementById('editTagModal');
                const tagId = modal.dataset.tagId;

                if (!tagId) return;

                const name = document.getElementById('editTagName').value.trim();
                const colorRadio = document.querySelector('input[name="editTagColor"]:checked');
                const color = colorRadio ? colorRadio.value : '#667eea';

                if (!name) {
                    showStatus('Tag name is required', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/tags/${tagId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('âœ… Tag successfully updated!', 'success');
                        closeEditTagModal();
                        loadData();
                    } else {
                        showStatus('âŒ Error while updating: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error while updating: ' + error.message, 'error');
                }
            }

            // Show modal for deleting a tag
            function showDeleteTagModal(tagId, tagName) {
                const modal = document.getElementById('deleteTagModal');
                const nameEl = document.getElementById('deleteTagName');
                nameEl.textContent = tagName;

                modal.dataset.tagId = tagId;
                modal.classList.add('show');
            }

            function closeDeleteTagModal() {
                const modal = document.getElementById('deleteTagModal');
                modal.classList.remove('show');
                delete modal.dataset.tagId;
            }

            // Delete tag
            async function deleteTag() {
                const modal = document.getElementById('deleteTagModal');
                const tagId = modal.dataset.tagId;

                if (!tagId) return;

                try {
                    const response = await fetch(`${API_URL}/api/tags/${tagId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('âœ… Tag successfully deleted!', 'success');
                        closeDeleteTagModal();
                        loadData();
                    } else {
                        showStatus('âŒ Error while deleting: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error while deleting: ' + error.message, 'error');
                }
            }

            // Show modal for editing a category
            function showEditCategoryModal(categoryId, categoryName, categoryColor) {
                const modal = document.getElementById('editCategoryModal');

                document.getElementById('editCategoryName').value = categoryName;

                // Set the radio button for the matching color
                const colorRadio = document.querySelector(`input[name = "editCategoryColor"][value = "${categoryColor}"]`);
                if (colorRadio) {
                    colorRadio.checked = true;
                } else {
                    // Default to first color if no match
                    document.getElementById('editCatColor1').checked = true;
                }

                modal.dataset.categoryId = categoryId;
                modal.classList.add('show');
            }

            function closeEditCategoryModal() {
                const modal = document.getElementById('editCategoryModal');
                modal.classList.remove('show');
                document.getElementById('editCategoryForm').reset();
                delete modal.dataset.categoryId;
            }

            // Save category changes
            async function saveEditedCategory(e) {
                e.preventDefault();

                const modal = document.getElementById('editCategoryModal');
                const categoryId = modal.dataset.categoryId;

                if (!categoryId) return;

                const name = document.getElementById('editCategoryName').value.trim();
                const colorRadio = document.querySelector('input[name="editCategoryColor"]:checked');
                const color = colorRadio ? colorRadio.value : '#667eea';

                if (!name) {
                    showStatus('Category name is required', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/api/categories/${categoryId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            color
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus('âœ… Category successfully updated!', 'success');
                        closeEditCategoryModal();
                        loadData();
                    } else {
                        showStatus('âŒ Error while updating: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Error while updating: ' + error.message, 'error');
                }
            }
            document.addEventListener('DOMContentLoaded', () => {
                checkServerStatus();
                loadData();

                // Refresh server status every 30 seconds
                setInterval(checkServerStatus, 30000);

                // Event listeners for delete modal
                document.getElementById('confirmDelete').addEventListener('click', deleteSite);
                document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);

                // Event listeners for edit modal
                document.getElementById('editForm').addEventListener('submit', saveEditedSite);
                document.getElementById('cancelEdit').addEventListener('click', closeEditModal);

                // Event listeners for delete modal (categories)
                document.getElementById('confirmDeleteCategory').addEventListener('click', deleteCategory);
                document.getElementById('cancelDeleteCategory').addEventListener('click', closeDeleteCategoryModal);

                // Event listeners for edit modal (categories)
                document.getElementById('editCategoryForm').addEventListener('submit', saveEditedCategory);
                document.getElementById('cancelEditCategory').addEventListener('click', closeEditCategoryModal);

                // Event listeners for delete modal (tags)
                document.getElementById('confirmDeleteTag').addEventListener('click', deleteTag);
                document.getElementById('cancelDeleteTag').addEventListener('click', closeDeleteTagModal);

                // Event listeners for edit modal (tags)
                document.getElementById('editTagForm').addEventListener('submit', saveEditedTag);
                document.getElementById('cancelEditTag').addEventListener('click', closeEditTagModal);

                document.getElementById('deleteModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeDeleteModal();
                    }
                });

                document.getElementById('editModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeEditModal();
                    }
                });

                document.getElementById('deleteCategoryModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeDeleteCategoryModal();
                    }
                });

                document.getElementById('editCategoryModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeEditCategoryModal();
                    }
                });

                document.getElementById('editTagModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeEditTagModal();
                    }
                });

                // Close date filter modal on outside click
                const dateFilterModalEl = document.getElementById('dateFilterModal');
                if (dateFilterModalEl) {
                    dateFilterModalEl.addEventListener('click', function (event) {
                        if (event.target === this) {
                            closeDateFilterModal();
                        }
                    });
                }

                document.getElementById('deleteTagModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeDeleteTagModal();
                    }
                });

                // Close add site modal on outside click
                document.getElementById('addSiteModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeAddSiteModal();
                    }
                });

                // Close add category modal on outside click
                document.getElementById('addCategoryModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeAddCategoryModal();
                    }
                });

                // Close add tag modal on outside click
                document.getElementById('addTagModal').addEventListener('click', function (event) {
                    if (event.target === this) {
                        closeAddTagModal();
                    }
                });

                // Delegate clicks inside the categories table to toggle selection reliably
                (function () {
                    const categoriesContainerEl = document.getElementById('categoriesContainer');
                    if (categoriesContainerEl) {
                        categoriesContainerEl.addEventListener('click', function (e) {
                            // Find the row that was clicked
                            const tr = e.target.closest('tr[data-category-id]');
                            if (!tr) return;

                            // Ignore clicks inside action icons (edit/delete buttons)
                            if (e.target.closest('.action-icons')) return;

                            // Ignore clicks on the category link itself (it loads category view)
                            if (e.target.tagName === 'A') return;

                            console.log('Category row clicked (delegate)', { id: tr.dataset.categoryId, tag: e.target.tagName });

                            // Call toggler using the row as context
                            if (window.toggleCategoryRowSelection) {
                                window.toggleCategoryRowSelection.call(tr, e, tr.dataset.categoryId);
                            }
                        });
                    }
                })();

                // Delegate clicks on the tabs header so clicking icons, labels or counts always activates the tab
                (function () {
                    const tabsHeaderEl = document.querySelector('.tabs-header');
                    if (tabsHeaderEl) {
                        tabsHeaderEl.addEventListener('click', function (e) {
                            const btn = e.target.closest('.tab-button');
                            if (!btn) return;
                            // Determine tabName from data-tab or onclick string
                            const tabName = btn.dataset.tab || (btn.getAttribute('onclick') && (btn.getAttribute('onclick').match(/switchTab\(['"]([^'\"]+)['"]/ || [])[1]));
                            if (tabName) {
                                // Use switchTab to perform activation and content swapping
                                if (typeof switchTab === 'function') switchTab(tabName, btn);
                                else {
                                    // Fallback: apply .active visually
                                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                                    btn.classList.add('active');
                                }
                            }
                        });
                    }
                })();

                // Add explicit click handlers on each tab button as a fallback (ensures clicks on inner elements work in all browsers)
                (function () {
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            // Stop propagation so delegation doesn't double-handle
                            e.stopPropagation();
                            const tabName = this.dataset.tab || (this.getAttribute('onclick') && (this.getAttribute('onclick').match(/switchTab\(['"]([^'\"]+)['"]/ || [])[1]));
                            if (tabName && typeof switchTab === 'function') switchTab(tabName, this);
                        });
                    });
                })();

                // Clear selections when clicking outside selectable rows or controls
                document.addEventListener('click', function (e) {
                    const t = e.target;
                    // If clicking on a selectable row, do nothing (selection is handled elsewhere)
                    if (t.closest('tr[data-site-id], tr[data-category-id], tr[data-tag-id]')) return;
                    // If clicking inside controls or other interactive elements, do nothing
                    if (t.closest('.bulk-action-bar, .left-controls-group, .search-bar-wrapper, .modal, .action-icons, .tab-button, .btn-add, .add-site-button-group')) return;

                    // Otherwise clear any existing selection
                    if ((typeof selectedSiteIds !== 'undefined' && selectedSiteIds.size > 0) ||
                        (typeof selectedTagIds !== 'undefined' && selectedTagIds.size > 0) ||
                        (typeof selectedCategoryIds !== 'undefined' && selectedCategoryIds.size > 0)) {
                        clearSelection(); clearTagSelection(); clearCategorySelection();
                    }
                });

                // Close modals on ESC key press
                document.addEventListener('keydown', function (event) {
                    if (event.key === 'Escape') {
                        // Close any open modal
                        const deleteModal = document.getElementById('deleteModal');
                        const editModal = document.getElementById('editModal');
                        const addSiteModal = document.getElementById('addSiteModal');
                        const deleteCategoryModal = document.getElementById('deleteCategoryModal');
                        const editCategoryModal = document.getElementById('editCategoryModal');
                        const addCategoryModal = document.getElementById('addCategoryModal');
                        const editTagModal = document.getElementById('editTagModal');
                        const deleteTagModal = document.getElementById('deleteTagModal');
                        const addTagModal = document.getElementById('addTagModal');

                        if (deleteModal && deleteModal.classList.contains('show')) closeDeleteModal();
                        else if (editModal && editModal.classList.contains('show')) closeEditModal();
                        else if (addSiteModal && addSiteModal.classList.contains('show')) closeAddSiteModal();
                        else if (deleteCategoryModal && deleteCategoryModal.classList.contains('show')) closeDeleteCategoryModal();
                        else if (editCategoryModal && editCategoryModal.classList.contains('show')) closeEditCategoryModal();
                        else if (addCategoryModal && addCategoryModal.classList.contains('show')) closeAddCategoryModal();
                        else if (editTagModal && editTagModal.classList.contains('show')) closeEditTagModal();
                        else if (deleteTagModal && deleteTagModal.classList.contains('show')) closeDeleteTagModal();
                        else if (addTagModal && addTagModal.classList.contains('show')) closeAddTagModal();
                        else {
                            // If no modal was open, also close the date filter modal (if open)
                            const df = document.getElementById('dateFilterModal');
                            const dt = document.getElementById('dateFilterToggle');
                            if (df && df.classList.contains('show')) {
                                df.classList.remove('show');
                                if (dt) { dt.classList.remove('active'); dt.setAttribute('aria-expanded', 'false'); }
                            }
                        }
                    }
                });
            });

            // ========== ADD CATEGORY FUNCTIONS ==========

            function showAddCategoryModal() {
                const addCategoryModal = document.getElementById('addCategoryModal');

                // Reset form
                document.getElementById('addCategoryName').value = '';
                // Reset to default color (Blue)
                document.getElementById('addCatColor2').checked = true;

                // Hide message
                // (Removed misplaced bulk-delete rendering inserted here)
                // nothing to show for bulk delete when opening the Add Category modal

                // Hide message
                const messageEl = document.getElementById('addTagMessage');
                messageEl.className = 'add-site-message';
                messageEl.textContent = '';

                addCategoryModal.classList.add('show');
            }

            function closeAddCategoryModal() {
                const modal = document.getElementById('addCategoryModal');
                if (modal) modal.classList.remove('show');

                // Reset form and clear messages
                const form = document.getElementById('addCategoryForm');
                if (form) form.reset();

                const messageEl = document.getElementById('addCategoryMessage');
                if (messageEl) {
                    messageEl.className = 'add-site-message';
                    messageEl.textContent = '';
                }
            }

            function showAddTagModal() {
                const modal = document.getElementById('addTagModal');

                // Reset form fields
                document.getElementById('addTagName').value = '';
                // Default to first color (Purple)
                const defaultColorRadio = document.getElementById('addTagColor1');
                if (defaultColorRadio) defaultColorRadio.checked = true;

                // Clear message
                const messageEl = document.getElementById('addTagMessage');
                if (messageEl) {
                    messageEl.className = 'add-site-message';
                    messageEl.textContent = '';
                }

                modal.classList.add('show');
            }

            function closeAddTagModal() {
                document.getElementById('addTagModal').classList.remove('show');
            }

            document.getElementById('addTagForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const name = document.getElementById('addTagName').value.trim();
                const colorRadio = document.querySelector('input[name="addTagColor"]:checked');
                const color = colorRadio ? colorRadio.value : '#667eea';
                const messageEl = document.getElementById('addTagMessage');

                // Helper for showing message in modal
                function showAddMessage(text, type) {
                    messageEl.textContent = text;
                    messageEl.className = 'add-site-message ' + type;
                }

                if (!name) {
                    showAddMessage('Tag name is required', 'error');
                    return;
                }

                showAddMessage('Adding tag...', 'success');

                try {
                    const response = await fetch(`${API_URL}/api/tags`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showAddMessage('âœ… Tag successfully added!', 'success');

                        // Add new tag immediately to allTags array
                        if (data.data && data.data.id) {
                            allTags.push(data.data);

                            // Refresh checkbox list in edit modal if open
                            const tagsList = document.getElementById('editTagsCheckboxList');
                            if (tagsList && tagsList.innerHTML) {

                                // Generate new checkbox for tag
                                const tag = data.data;
                                const index = allTags.length - 1;
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'add-site-checkbox-item';

                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.id = `editTag_${index}_${tag.id} `;
                                checkbox.value = tag.id;
                                checkbox.checked = false;

                                const label = document.createElement('label');
                                label.htmlFor = checkbox.id;
                                label.textContent = tag.name;



                                itemDiv.onclick = (e) => {
                                    checkbox.checked = !checkbox.checked;
                                };

                                itemDiv.appendChild(checkbox);
                                itemDiv.appendChild(label);
                                tagsList.appendChild(itemDiv);
                            }
                        }

                        setTimeout(() => {
                            closeAddTagModal();
                            loadData();
                        }, 1000);
                    } else {
                        showAddMessage('âŒ ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showAddMessage('âŒ Error: ' + error.message, 'error');
                }
            });

            // Add category form submit handler
            document.getElementById('addCategoryForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const name = document.getElementById('addCategoryName').value.trim();
                const colorRadio = document.querySelector('input[name="addCategoryColor"]:checked');
                const color = colorRadio ? colorRadio.value : '#6CBBFB';
                const messageEl = document.getElementById('addCategoryMessage');

                function showAddCategoryMessage(text, type) {
                    messageEl.textContent = text;
                    messageEl.className = 'add-site-message ' + type;
                }

                if (!name) {
                    showAddCategoryMessage('Category name is required', 'error');
                    return;
                }

                showAddCategoryMessage('Adding category...', 'success');

                try {
                    const response = await fetch(`${API_URL}/api/categories`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });

                    // Parse body safely (handle non-JSON error bodies)
                    const text = await response.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseErr) {
                        data = { error: text || response.statusText };
                    }

                    if (response.ok && data.success) {
                        showAddCategoryMessage('âœ… Category successfully added!', 'success');

                        if (data.data && data.data.id) {
                            allCategories.push(data.data);
                        }

                        setTimeout(() => {
                            closeAddCategoryModal();
                            loadData();
                        }, 800);
                    } else {
                        const errMsg = data.error || data.message || `Server responded: ${response.status} ${response.statusText}`;
                        console.error('Add category failed', response.status, errMsg);
                        showAddCategoryMessage('âŒ ' + errMsg, 'error');
                    }
                } catch (err) {
                    console.error('Add category exception', err);
                    showAddCategoryMessage('âŒ Error: ' + err.message, 'error');
                }
            });

            // ========== ADD SITE FUNCTIONS ==========

            function showAddSiteModal() {
                const modal = document.getElementById('addSiteModal');

                // Reset form
                document.getElementById('addName').value = '';
                document.getElementById('addUrl').value = '';
                document.getElementById('addPricing').value = '';

                const messageEl = document.getElementById('addSiteMessage');
                messageEl.className = 'add-site-message';
                messageEl.textContent = '';

                const categoriesContainer = document.getElementById('addCategoriesCheckboxList');
                categoriesContainer.innerHTML = '';

                allCategories.forEach((cat, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'add-site-checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = cat.name;
                    checkbox.id = `addCat_${index}_${cat.id} `;
                    checkbox.className = 'add-category-checkbox';

                    // On category page, automatically select current category
                    if (window.currentCategoryName && cat.name === window.currentCategoryName) {
                        checkbox.checked = true;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = cat.name;

                    // Add colors as in the table
                    const catColor = cat.color || '#6CBBFB';
                    itemDiv.style.background = catColor + '20';
                    itemDiv.style.color = catColor;
                    itemDiv.style.border = '1px solid ' + catColor + '40';
                    label.style.color = catColor;

                    itemDiv.onclick = (e) => {
                        checkbox.checked = !checkbox.checked;

                        if (checkbox.checked) {
                            // Add outline
                            itemDiv.style.outline = '1px solid ' + catColor;
                            itemDiv.style.outlineOffset = '2px';
                            itemDiv.style.fontWeight = '700';
                        } else {
                            // Remove outline if deselected
                            itemDiv.style.outline = 'none';
                            itemDiv.style.fontWeight = '600';
                        }
                    };

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    categoriesContainer.appendChild(itemDiv);
                });

                const tagsContainer = document.getElementById('addTagsCheckboxList');
                tagsContainer.innerHTML = '';

                allTags.forEach((tag, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'add-site-checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = tag.id;
                    checkbox.id = `addTag_${index}_${tag.id} `;
                    checkbox.className = 'add-tag-checkbox';

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = tag.name;

                    // Add colors as in the table
                    const tagColor = tag.color || '#667eea';
                    itemDiv.style.background = tagColor + '20';
                    itemDiv.style.color = tagColor;
                    itemDiv.style.border = '1px solid ' + tagColor + '40';
                    label.style.color = tagColor;

                    itemDiv.onclick = (e) => {
                        checkbox.checked = !checkbox.checked;

                        if (checkbox.checked) {
                            // Add outline
                            itemDiv.style.outline = '1px solid ' + tagColor;
                            itemDiv.style.outlineOffset = '2px';
                            itemDiv.style.fontWeight = '700';
                        } else {
                            // Remove outline if deselected
                            itemDiv.style.outline = 'none';
                            itemDiv.style.fontWeight = '600';
                        }
                    };

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    tagsContainer.appendChild(itemDiv);
                });

                // Reset forme
                document.getElementById('addUrl').value = '';
                document.getElementById('addPricing').value = '';

                modal.classList.add('show');
            }

            function closeAddSiteModal() {
                document.getElementById('addSiteModal').classList.remove('show');
            }

            // Submit handler za edit site form
            document.getElementById('editForm').addEventListener('submit', saveEditedSite);

            // Cancel button za edit modal
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);

            // Submit handler za add site form
            document.getElementById('addSiteForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const name = document.getElementById('addName').value.trim();
                const url = document.getElementById('addUrl').value.trim();
                const pricing = document.getElementById('addPricing').value;
                const messageEl = document.getElementById('addSiteMessage');

                // Helper for showing message in modal
                function showAddMessage(text, type) {
                    messageEl.textContent = text;
                    messageEl.className = 'add-site-message ' + type;
                }

                // Collect selected categories
                const selectedCategories = [];
                document.querySelectorAll('.add-category-checkbox:checked').forEach(cb => {
                    selectedCategories.push(cb.value);
                });

                // Collect selected tags
                const selectedTagIds = [];
                document.querySelectorAll('.add-tag-checkbox:checked').forEach(cb => {
                    selectedTagIds.push(cb.value);
                });

                // Validation
                if (!name) {
                    showAddMessage('Site name is required', 'error');
                    return;
                }
                if (!url) {
                    showAddMessage('URL address is required', 'error');
                    return;
                }
                if (selectedCategories.length === 0) {
                    showAddMessage('Select at least one category', 'error');
                    return;
                }
                if (selectedTagIds.length === 0) {
                    showAddMessage('Select at least one tag', 'error');
                    return;
                }
                if (!pricing) {
                    showAddMessage('Select billing model', 'error');
                    return;
                }

                showAddMessage('Adding website...', 'success');

                try {
                    const response = await fetch(`${API_URL}/api/sites`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            url,
                            categories: selectedCategories,
                            tag_ids: selectedTagIds,
                            pricing,
                            user_id: currentUser?.id
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showAddMessage('âœ… Site successfully added!', 'success');
                        setTimeout(() => {
                            closeAddSiteModal();
                            loadData(); // Refresh data with tags
                        }, 1000);
                    } else {
                        showAddMessage('âŒ ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    showAddMessage('âŒ Error: ' + error.message, 'error');
                }
            });

            // ========== TABLE SORTING ==========
            let sortState = {
                sitesContainer: { column: null, ascending: true },
                categoriesContainer: { column: null, ascending: true },
                tagsContainer: { column: null, ascending: true }
            };

            function sortTable(containerId, columnIndex, tableType) {
                const container = document.getElementById(containerId);
                const table = container.querySelector('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const headers = table.querySelectorAll('thead th');

                // Check if same column was clicked
                if (sortState[containerId].column === columnIndex) {
                    // Change sort direction
                    sortState[containerId].ascending = !sortState[containerId].ascending;
                } else {
                    // New column clicked
                    sortState[containerId].column = columnIndex;
                    sortState[containerId].ascending = true;
                }

                // Update arrows
                headers.forEach((header, index) => {
                    const icon = header.querySelector('.sort-icon');
                    if (icon) {
                        icon.className = 'sort-icon inactive';
                        if (index === columnIndex) {
                            icon.className = sortState[containerId].ascending ? 'sort-icon asc active' : 'sort-icon desc active';
                        }
                    }
                });

                // Sort rows
                rows.sort((a, b) => {
                    let aValue = a.cells[columnIndex].textContent.trim();
                    let bValue = b.cells[columnIndex].textContent.trim();

                    // Try to convert to number if possible
                    const aNum = parseFloat(aValue);
                    const bNum = parseFloat(bValue);

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        // Numeric sorting
                        return sortState[containerId].ascending ? aNum - bNum : bNum - aNum;
                    } else {
                        // Alphanumeric sorting (case-insensitive)
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                        return sortState[containerId].ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                    }
                });

                // Re-render rows in table
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            }

            // Data loading is now handled by showDashboard() after successful login

            // ========== SEARCH/FILTER FUNCTIONS ==========
            function filterSites() {
                const searchTerm = document.getElementById('sitesSearch').value.toLowerCase();
                const container = document.getElementById('sitesContainer');
                const rows = container.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const siteName = row.cells[0].textContent.toLowerCase();
                    const siteUrl = row.cells[1].textContent.toLowerCase();

                    // Basic search match
                    let visibleBySearch = (siteName.includes(searchTerm) || siteUrl.includes(searchTerm));

                    // Date filter: read ISO from data attribute and compare
                    const createdIso = row.getAttribute('data-created');
                    let visibleByDate = true;
                    if (createdIso) {
                        visibleByDate = isDateInFilter(createdIso);
                    }

                    if (visibleBySearch && visibleByDate) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            function filterCategories() {
                const searchTerm = document.getElementById('categoriesSearch').value.toLowerCase();
                const container = document.getElementById('categoriesContainer');
                const rows = container.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const categoryName = row.cells[0].textContent.toLowerCase();

                    if (categoryName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            function filterTags() {
                const searchTerm = document.getElementById('tagsSearch').value.toLowerCase();
                const container = document.getElementById('tagsContainer');
                const rows = container.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const tagName = row.cells[0].textContent.toLowerCase();

                    if (tagName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Initialize search listeners after tables load
            function initSearchListeners() {
                const sitesSearch = document.getElementById('sitesSearch');
                if (sitesSearch) {
                    sitesSearch.addEventListener('input', filterSites);
                }

                const categoriesSearch = document.getElementById('categoriesSearch');
                if (categoriesSearch) {
                    categoriesSearch.addEventListener('input', filterCategories);
                }

                const tagsSearch = document.getElementById('tagsSearch');
                if (tagsSearch) {
                    tagsSearch.addEventListener('input', filterTags);
                }
            }

            // Call initialization when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                initSearchListeners();

                // Keyboard shortcuts (context-aware)
                // Shortcuts:
                //  - Ctrl/Cmd + A : Select all visible items (current tab)
                //  - Delete       : Open bulk delete (or confirm current delete modal)
                //  - Ctrl/Cmd + E : Edit (bulk edit - only if 1 selected)
                //  - Ctrl/Cmd + S : Save (submit edit modal)
                //  - Ctrl/Cmd + . : Cancel (close bulk delete or modals)
                //  - Esc          : Close modals or clear selection when none open
                document.addEventListener('keydown', function (e) {
                    // Ignore when typing in inputs/selects/textareas
                    const active = document.activeElement;
                    const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT' || active.isContentEditable);
                    if (isTyping) return;

                    const activeTabId = (document.querySelector('.tab-content.active') || {}).id || 'sitesTab';
                    const isSites = activeTabId === 'sitesTab';
                    const isCategories = activeTabId === 'categoriesTab';
                    const isTags = activeTabId === 'tagsTab';

                    // Ctrl/Cmd + A => select all
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a') {
                        e.preventDefault();
                        if (isSites) selectAllSites();
                        else if (isCategories) selectAllCategories();
                        else if (isTags) selectAllTags();
                        showStatus('âœ… Selected all visible items', 'success');
                        return;
                    }

                    // Delete => confirm modal if open, otherwise open bulk delete if selection exists
                    if (e.key === 'Delete') {
                        e.preventDefault();
                        // If a delete modal is open, confirm it
                        if (document.getElementById('deleteModal')?.classList.contains('show')) {
                            const btn = document.getElementById('confirmDelete'); if (btn) btn.click(); return;
                        }
                        if (document.getElementById('deleteCategoryModal')?.classList.contains('show')) {
                            const btn = document.getElementById('confirmDeleteCategory'); if (btn) btn.click(); return;
                        }
                        if (document.getElementById('deleteTagModal')?.classList.contains('show')) {
                            const btn = document.getElementById('confirmDeleteTag'); if (btn) btn.click(); return;
                        }

                        // Otherwise open bulk delete for current tab if items are selected
                        if (isSites && selectedSiteIds && selectedSiteIds.size > 0) { showBulkDeleteModal(); return; }
                        if (isCategories && selectedCategoryIds && selectedCategoryIds.size > 0) { showBulkDeleteCategoriesModal(); return; }
                        if (isTags && selectedTagIds && selectedTagIds.size > 0) { showBulkDeleteTagsModal(); return; }
                    }

                    // Enter => when modal open: confirm or submit
                    if (e.key === 'Enter') {
                        // Ignore Enter while typing multi-line input
                        if (active && active.tagName === 'TEXTAREA') return;

                        // If any delete confirmation modal is open, confirm it
                        const deleteModalEl = document.getElementById('deleteModal');
                        if (deleteModalEl && deleteModalEl.classList.contains('show')) { e.preventDefault(); document.getElementById('confirmDelete')?.click(); return; }

                        const deleteCatEl = document.getElementById('deleteCategoryModal');
                        if (deleteCatEl && deleteCatEl.classList.contains('show')) { e.preventDefault(); document.getElementById('confirmDeleteCategory')?.click(); return; }

                        const deleteTagEl = document.getElementById('deleteTagModal');
                        if (deleteTagEl && deleteTagEl.classList.contains('show')) { e.preventDefault(); document.getElementById('confirmDeleteTag')?.click(); return; }

                        // Bulk delete modal (compact) confirm
                        const bulkDeleteEl = document.getElementById('bulkDeleteModal');
                        if (bulkDeleteEl && bulkDeleteEl.classList.contains('show')) { e.preventDefault(); document.getElementById('confirmBulkDelete')?.click(); return; }

                        // If edit/add modals are open, submit their forms
                        const editModalEl = document.getElementById('editModal');
                        if (editModalEl && editModalEl.classList.contains('show')) { e.preventDefault(); const form = document.getElementById('editForm'); if (form && form.requestSubmit) form.requestSubmit(); else if (form) form.submit(); return; }

                        const editCatEl = document.getElementById('editCategoryModal');
                        if (editCatEl && editCatEl.classList.contains('show')) { e.preventDefault(); const form = document.getElementById('editCategoryForm'); if (form && form.requestSubmit) form.requestSubmit(); else if (form) form.submit(); return; }

                        const editTagEl = document.getElementById('editTagModal');
                        if (editTagEl && editTagEl.classList.contains('show')) { e.preventDefault(); const form = document.getElementById('editTagForm'); if (form && form.requestSubmit) form.requestSubmit(); else if (form) form.submit(); return; }

                        const addSiteEl = document.getElementById('addSiteModal');
                        if (addSiteEl && addSiteEl.classList.contains('show')) { e.preventDefault(); const form = document.getElementById('addSiteForm'); if (form && form.requestSubmit) form.requestSubmit(); else if (form) form.submit(); return; }
                    }

                    // Ctrl/Cmd + E => bulk edit (works when exactly one item is selected)
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'e') {
                        e.preventDefault();
                        if (isSites) bulkEditSites();
                        else if (isCategories) bulkEditCategories();
                        else if (isTags) bulkEditTags();
                        return;
                    }

                    // Ctrl/Cmd + S => Save if edit modal is open
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                        const editModal = document.getElementById('editModal');
                        const editCatModal = document.getElementById('editCategoryModal');
                        const editTagModal = document.getElementById('editTagModal');
                        if ((editModal && editModal.classList.contains('show')) || (editCatModal && editCatModal.classList.contains('show')) || (editTagModal && editTagModal.classList.contains('show'))) {
                            e.preventDefault();
                            if (editModal && editModal.classList.contains('show')) {
                                const form = document.getElementById('editForm'); if (form && form.requestSubmit) form.requestSubmit();
                                else if (form) form.submit();
                            } else if (editCatModal && editCatModal.classList.contains('show')) {
                                const form = document.getElementById('editCategoryForm'); if (form && form.requestSubmit) form.requestSubmit();
                                else if (form) form.submit();
                            } else if (editTagModal && editTagModal.classList.contains('show')) {
                                const form = document.getElementById('editTagForm'); if (form && form.requestSubmit) form.requestSubmit();
                                else if (form) form.submit();
                            }
                            return;
                        }
                    }

                    // Ctrl/Cmd + . => Cancel / close bulk delete / modals
                    if ((e.ctrlKey || e.metaKey) && e.key === '.') {
                        e.preventDefault();
                        if (document.getElementById('bulkDeleteModal')?.classList.contains('show')) { cancelBulkDelete(); return; }
                        // close any other modal if open
                        const modalIds = ['deleteModal', 'editModal', 'addSiteModal', 'deleteCategoryModal', 'editCategoryModal', 'addCategoryModal', 'editTagModal', 'deleteTagModal', 'addTagModal'];
                        for (const id of modalIds) {
                            const m = document.getElementById(id);
                            if (m && m.classList.contains('show')) { m.classList.remove('show'); return; }
                        }
                    }

                    // Esc => if no modal open, clear selections
                    if (e.key === 'Escape') {
                        const modalIds = ['deleteModal', 'editModal', 'addSiteModal', 'deleteCategoryModal', 'editCategoryModal', 'addCategoryModal', 'editTagModal', 'deleteTagModal', 'addTagModal'];
                        const anyOpen = modalIds.some(id => document.getElementById(id)?.classList.contains('show'));
                        if (!anyOpen) { clearSelection(); clearTagSelection(); clearCategorySelection(); }
                    }
                });

            });
        </script>
        <script>
            function updateSyncBadge(state, timestamp = new Date()) {
                const button = document.getElementById('syncButton');
                const dot = document.getElementById('syncStatusDot');
                const spinner = document.getElementById('syncSpinner');
                const displayTime = timestamp ? timestamp.toLocaleString() : 'never';
                if (button) button.title = 'Last sync: ' + displayTime;
                if (dot) dot.className = 'status-dot server-dot-inline ' + (state === 'success' ? 'online' : state === 'pending' ? 'pending' : 'offline');
                if (spinner) spinner.style.display = state === 'pending' ? 'inline-block' : 'none';
                if (state === 'success') {
                    try { localStorage.setItem('lastSync', timestamp.toISOString()); } catch (e) { }
                }
            }

            // Restore lastSync from localStorage if present
            (function () {
                try {
                    const last = localStorage.getItem('lastSync');
                    if (last) {
                        updateSyncBadge('success', new Date(last));
                    }
                } catch (e) { }
            })();

            // Ensure sync icon is hidden while spinner runs (avoid double-icon flash)
            (function () {
                // If updateSyncBadge already exists, wrap it to enforce icon visibility
                if (window.updateSyncBadge && typeof window.updateSyncBadge === 'function') {
                    const _orig = window.updateSyncBadge;
                    window.updateSyncBadge = function (state, timestamp) {
                        try {
                            const icon = document.getElementById('syncIcon');
                            const spinner = document.getElementById('syncSpinner');
                            if (state === 'pending') {
                                if (icon) icon.style.display = 'none';
                                if (spinner) spinner.style.display = 'inline-block';
                            } else {
                                if (icon) icon.style.display = 'inline-block';
                                if (spinner) spinner.style.display = 'none';
                            }
                        } catch (err) {
                            console.warn('updateSyncBadge wrapper error', err);
                        }
                        return _orig(state, timestamp);
                    };
                }
            })();

            // Export menu attached to Sync: toggle/close helpers
            function toggleSyncExportMenu() {
                const m = document.getElementById('syncExportMenu');
                const t = document.getElementById('syncExportToggle');
                if (!m) return;
                const isOpen = m.classList.toggle('open');
                if (t) t.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            }
            function closeSyncExportMenu() {
                const m = document.getElementById('syncExportMenu');
                const t = document.getElementById('syncExportToggle');
                if (m) m.classList.remove('open');
                if (t) t.setAttribute('aria-expanded', 'false');
            }

            // General click listener: close export menus when clicking outside
            document.addEventListener('click', (e) => {
                // legacy exportMenu (if present)
                if (!e.target.closest('#exportMenu') && !e.target.closest('#exportToggle')) {
                    const d = document.getElementById('exportMenu');
                    if (d) d.classList.remove('open');
                }
                // sync-attached export menu
                if (!e.target.closest('#syncExportMenu') && !e.target.closest('#syncExportToggle')) {
                    closeSyncExportMenu();
                }
                // date filter modal
                if (!e.target.closest('#dateFilterModal') && !e.target.closest('#dateFilterToggle')) {
                    const df = document.getElementById('dateFilterModal'); if (df) df.classList.remove('show');
                    const td = document.getElementById('dateFilterToggle'); if (td) { td.setAttribute('aria-expanded', 'false'); td.classList.remove('active'); }
                }
            });
        </script>

</body>

</html>